{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:2fa/server/lib/totp.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/checkCodesRemaining.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/disable.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/enable.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/regenerateCodes.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/validateTempToken.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/models/users.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/loginHandler.js"],"names":["speakeasy","module","watch","require","default","v","RocketChat","TOTP","generateSecret","generateOtpauthURL","secret","username","otpauthURL","ascii","label","verify","token","backupTokens","userId","verified","length","hashedCode","SHA256","usedCode","indexOf","splice","models","Users","update2FABackupCodesByUserId","totp","encoding","generateCodes","codes","hashedCodes","i","code","Random","id","push","Meteor","methods","Error","user","services","enabled","remaining","hashedBackup","disable2FAByUserId","disable2FAAndSetTempSecretByUserId","base32","url","userToken","tempSecret","enable2FAAndSetSecretAndCodesByUserId","tempToken","update","_id","$set","backupCodes","$unset","Accounts","registerLoginHandler","options","_runLoginHandlers","login","callbacks","add","type","methodArguments"],"mappings":"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","file":"/packages/rocketchat_2fa.js","sourcesContent":["import speakeasy from 'speakeasy';\n\nRocketChat.TOTP = {\n\tgenerateSecret() {\n\t\treturn speakeasy.generateSecret();\n\t},\n\n\tgenerateOtpauthURL(secret, username) {\n\t\treturn speakeasy.otpauthURL({\n\t\t\tsecret: secret.ascii,\n\t\t\tlabel: `Rocket.Chat:${ username }`\n\t\t});\n\t},\n\n\tverify({ secret, token, backupTokens, userId }) {\n\t\tlet verified;\n\n\t\t// validates a backup code\n\t\tif (token.length === 8 && backupTokens) {\n\t\t\tconst hashedCode = SHA256(token);\n\t\t\tconst usedCode = backupTokens.indexOf(hashedCode);\n\n\t\t\tif (usedCode !== -1) {\n\t\t\t\tverified = true;\n\n\t\t\t\tbackupTokens.splice(usedCode, 1);\n\n\t\t\t\t// mark the code as used (remove it from the list)\n\t\t\t\tRocketChat.models.Users.update2FABackupCodesByUserId(userId, backupTokens);\n\t\t\t}\n\t\t} else {\n\t\t\tverified = speakeasy.totp.verify({\n\t\t\t\tsecret,\n\t\t\t\tencoding: 'base32',\n\t\t\t\ttoken\n\t\t\t});\n\t\t}\n\n\t\treturn verified;\n\t},\n\n\tgenerateCodes() {\n\t\t// generate 12 backup codes\n\t\tconst codes = [];\n\t\tconst hashedCodes = [];\n\t\tfor (let i = 0; i < 12; i++) {\n\t\t\tconst code = Random.id(8);\n\t\t\tcodes.push(code);\n\t\t\thashedCodes.push(SHA256(code));\n\t\t}\n\n\t\treturn { codes, hashedCodes };\n\t}\n};\n","Meteor.methods({\n\t'2fa:checkCodesRemaining'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.enabled) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\treturn {\n\t\t\tremaining: user.services.totp.hashedBackup.length\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'2fa:disable'(code) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.secret,\n\t\t\ttoken: code,\n\t\t\tuserId: Meteor.userId(),\n\t\t\tbackupTokens: user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (!verified) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn RocketChat.models.Users.disable2FAByUserId(Meteor.userId());\n\t}\n});\n","Meteor.methods({\n\t'2fa:enable'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst secret = RocketChat.TOTP.generateSecret();\n\n\t\tRocketChat.models.Users.disable2FAAndSetTempSecretByUserId(Meteor.userId(), secret.base32);\n\n\t\treturn {\n\t\t\tsecret: secret.base32,\n\t\t\turl: RocketChat.TOTP.generateOtpauthURL(secret, user.username)\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'2fa:regenerateCodes'(userToken) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.enabled) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.secret,\n\t\t\ttoken: userToken,\n\t\t\tuserId: Meteor.userId(),\n\t\t\tbackupTokens: user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (verified) {\n\t\t\tconst { codes, hashedCodes } = RocketChat.TOTP.generateCodes();\n\n\t\t\tRocketChat.models.Users.update2FABackupCodesByUserId(Meteor.userId(), hashedCodes);\n\t\t\treturn { codes };\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'2fa:validateTempToken'(userToken) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.tempSecret) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.tempSecret,\n\t\t\ttoken: userToken\n\t\t});\n\n\t\tif (verified) {\n\t\t\tconst { codes, hashedCodes } = RocketChat.TOTP.generateCodes();\n\n\t\t\tRocketChat.models.Users.enable2FAAndSetSecretAndCodesByUserId(Meteor.userId(), user.services.totp.tempSecret, hashedCodes);\n\t\t\treturn { codes };\n\t\t}\n\t}\n});\n","RocketChat.models.Users.disable2FAAndSetTempSecretByUserId = function(userId, tempToken) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp': {\n\t\t\t\tenabled: false,\n\t\t\t\ttempSecret: tempToken\n\t\t\t}\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.enable2FAAndSetSecretAndCodesByUserId = function(userId, secret, backupCodes) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp.enabled': true,\n\t\t\t'services.totp.secret': secret,\n\t\t\t'services.totp.hashedBackup': backupCodes\n\t\t},\n\t\t$unset: {\n\t\t\t'services.totp.tempSecret': 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.disable2FAByUserId = function(userId) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp': {\n\t\t\t\tenabled: false\n\t\t\t}\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.update2FABackupCodesByUserId = function(userId, backupCodes) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp.hashedBackup': backupCodes\n\t\t}\n\t});\n};\n","Accounts.registerLoginHandler('totp', function(options) {\n\tif (!options.totp || !options.totp.code) {\n\t\treturn;\n\t}\n\n\treturn Accounts._runLoginHandlers(this, options.totp.login);\n});\n\nRocketChat.callbacks.add('onValidateLogin', (login) => {\n\tif (login.type === 'password' && login.user.services && login.user.services.totp && login.user.services.totp.enabled === true) {\n\t\tconst { totp } = login.methodArguments[0];\n\n\t\tif (!totp || !totp.code) {\n\t\t\tthrow new Meteor.Error('totp-required', 'TOTP Required');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: login.user.services.totp.secret,\n\t\t\ttoken: totp.code,\n\t\t\tuserId: login.user._id,\n\t\t\tbackupTokens: login.user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (verified !== true) {\n\t\t\tthrow new Meteor.Error('totp-invalid', 'TOTP Invalid');\n\t\t}\n\t}\n});\n"]}