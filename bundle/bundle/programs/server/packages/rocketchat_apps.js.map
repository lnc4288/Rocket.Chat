{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:apps/lib/Apps.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/apps-logs-model.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/apps-model.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/apps-persistence-model.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/storage.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/index.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/storage/logs-storage.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/activation.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/bridges.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/commands.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/environmental.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/messages.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/persistence.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/rooms.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/settings.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/users.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/index.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/details.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/bridges/http.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/communication/methods.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/communication/rest.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/communication/websockets.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/communication/index.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/converters/messages.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/converters/rooms.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/converters/settings.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/converters/users.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/converters/index.js","meteor://ðŸ’»app/packages/rocketchat:apps/server/orchestrator.js"],"names":["Apps","module","export","AppsLogsModel","RocketChat","models","_Base","constructor","AppsModel","AppsPersistenceModel","AppRealStorage","AppStorage","watch","require","v","data","db","create","item","Promise","resolve","reject","createdAt","Date","updatedAt","doc","findOne","$or","id","info","nameSlug","e","Error","insert","_id","retrieveOne","retrieveAll","docs","find","fetch","items","Map","forEach","i","set","update","then","updated","catch","err","remove","success","AppRealLogsStorage","AppConsole","AppLogStorage","model","arguments","storeEntries","appId","logger","toStorageEntry","findOneById","getEntriesFor","AppActivationBridge","orch","appAdded","app","getNotifier","getID","appUpdated","appRemoved","appStatusChanged","status","appStatusUpdated","RealAppBridges","AppBridges","AppDetailChangesBridge","AppCommandsBridge","AppEnvironmentalVariableBridge","AppHttpBridge","AppMessageBridge","AppPersistenceBridge","AppRoomBridge","AppSettingBridge","AppUserBridge","_actBridge","_cmdBridge","_detBridge","_envBridge","_httpBridge","_msgBridge","_persistBridge","_roomBridge","_setsBridge","_userBridge","getCommandBridge","getEnvironmentalVariableBridge","getHttpBridge","getMessageBridge","getPersistenceBridge","getAppActivationBridge","getAppDetailChangesBridge","getRoomBridge","getServerSettingBridge","getUserBridge","SlashCommandContext","disabledCommands","doesCommandExist","command","console","log","length","cmd","toLowerCase","slashCommands","commands","has","enableCommand","trim","get","delete","commandUpdated","disableCommand","commandDisabled","modifyCommand","_verifyCommand","params","paramsExample","description","i18nDescription","callback","_appCommandExecutor","bind","registerCommand","commandAdded","unregisterCommand","commandRemoved","executor","parameters","message","user","getConverters","convertById","Meteor","userId","room","rid","split","context","Object","freeze","getManager","getCommandManager","executeCommand","allowed","getValueByName","envVarName","isReadable","process","env","includes","toUpperCase","isSet","msg","convertAppMessage","runAsUser","u","call","getById","messageId","editor","Messages","Users","updateMessage","purge","getPersistenceModel","createWithAssociations","associations","readById","record","readByAssociations","undefined","removeByAssociations","upsert","RoomType","rcRoom","convertAppRoom","method","type","CHANNEL","PRIVATE_GROUP","creator","usernames","roomId","getByName","roomName","convertByName","Rooms","rm","allowedGroups","disallowedSettings","getAll","Settings","$nin","map","s","convertToApp","getOneById","isReadableById","hideGroup","name","hideSetting","updateOne","setting","getByUsername","username","convertByUsername","onAppSettingsChange","appSettingsChange","warn","request","content","JSON","stringify","HTTP","url","response","AppMethods","manager","_manager","_addMethods","methods","areAppsLoaded","AppsRestApi","_orch","api","API","ApiClass","version","useDefaultAuth","prettyJson","enableCors","auth","getUserAuth","addManagementRoutes","_handleFile","fileField","Busboy","Npm","busboy","headers","wrapAsync","on","bindEnvironment","fieldname","file","fileData","push","Buffer","concat","pipe","orchestrator","fileHandler","addRoute","authRequired","apps","prl","getInfo","languages","getStorageItem","languageContent","getStatus","v1","post","buff","bodyParams","result","npmRequestOptions","encoding","statusCode","failure","error","from","add","toString","rl","urlParams","notFound","await","iconFileContent","offset","count","getPaginationItems","sort","fields","query","parseJsonQuery","ourQuery","assign","options","_updatedAt","skip","limit","logs","getLogStorage","settings","keys","k","hidden","getSettingsManager","updateAppSetting","settingId","getAppSetting","changeStatus","AppEvents","AppServerListener","AppServerNotifier","AppStatus","AppStatusUtils","APP_ADDED","APP_REMOVED","APP_UPDATED","APP_STATUS_CHANGE","APP_SETTING_UPDATED","COMMAND_ADDED","COMMAND_DISABLED","COMMAND_UPDATED","COMMAND_REMOVED","engineStreamer","clientStreamer","recieved","onAppAdded","onAppStatusUpdated","onAppSettingUpdated","onAppRemoved","onCommandAdded","onCommandDisabled","onCommandUpdated","onCommandRemoved","loadOne","emit","when","isEnabled","enable","isDisabled","disable","MANUALLY_DISABLED","Streamer","retransmit","serverOnly","allowRead","allowEmit","allowWrite","listener","details","AppMessagesConverter","msgId","convertMessage","msgObj","sender","editedBy","attachments","_convertAttachmentsToApp","text","ts","editedAt","emoji","avatarUrl","avatar","alias","customFields","_convertAppAttachments","Random","Array","isArray","attachment","collapsed","color","timestamp","message_link","timestampLink","thumb_url","thumbnailUrl","author_name","author","author_link","link","author_icon","icon","title","value","title_link","title_link_download","downloadLink","image_url","imageUrl","audio_url","audioUrl","video_url","videoUrl","AppRoomsConverter","_convertToApp","findOneByName","t","msgs","messageCount","default","isDefault","lm","lastModifiedAt","_convertTypeToApp","typeChar","DIRECT_MESSAGE","LIVE_CHAT","AppSettingsConverter","SettingType","packageValue","values","public","group","i18nLabel","BOOLEAN","CODE","COLOR","FONT","NUMBER","SELECT","STRING","AppUsersConverter","UserStatusConnection","UserType","findOneByUsername","_convertUserTypeToEnum","_convertStatusConnectionToEnum","statusConnection","emails","active","roles","utcOffset","lastLoginAt","lastLogin","USER","BOT","OFFLINE","ONLINE","AWAY","BUSY","AppManager","AppServerOrchestrator","Permissions","createOrUpdate","_model","_logModel","_persistModel","_storage","_logStorage","_converters","_bridges","_communicators","getModel","getStorage","getBridges","startup","_appServerOrchestrator","ENV_VAR_NAME_FOR_ENABLING","SUPER_FUN_ENV_ENABLEMENT_NAME","global","load"],"mappings":"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","file":"/packages/rocketchat_apps.js","sourcesContent":["// Please see both server and client's repsective \"orchestrator\" file for the contents\nApps = {};\n","export class AppsLogsModel extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('apps_logs');\n\t}\n}\n","export class AppsModel extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('apps');\n\t}\n}\n","export class AppsPersistenceModel extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('apps_persistence');\n\t}\n}\n","import { AppStorage } from '@rocket.chat/apps-engine/server/storage';\n\nexport class AppRealStorage extends AppStorage {\n\tconstructor(data) {\n\t\tsuper('mongodb');\n\t\tthis.db = data;\n\t}\n\n\tcreate(item) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\titem.createdAt = new Date();\n\t\t\titem.updatedAt = new Date();\n\n\t\t\tlet doc;\n\n\t\t\ttry {\n\t\t\t\tdoc = this.db.findOne({ $or: [{ id: item.id }, { 'info.nameSlug': item.info.nameSlug }] });\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tif (doc) {\n\t\t\t\treturn reject(new Error('App already exists.'));\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst id = this.db.insert(item);\n\t\t\t\titem._id = id;\n\n\t\t\t\tresolve(item);\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t}\n\n\tretrieveOne(id) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet doc;\n\n\t\t\ttry {\n\t\t\t\tdoc = this.db.findOne({ $or: [ {_id: id }, { id } ]});\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tif (doc) {\n\t\t\t\tresolve(doc);\n\t\t\t} else {\n\t\t\t\treject(new Error(`No App found by the id: ${ id }`));\n\t\t\t}\n\t\t});\n\t}\n\n\tretrieveAll() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet docs;\n\n\t\t\ttry {\n\t\t\t\tdocs = this.db.find({}).fetch();\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tconst items = new Map();\n\n\t\t\tdocs.forEach((i) => items.set(i.id, i));\n\n\t\t\tresolve(items);\n\t\t});\n\t}\n\n\tupdate(item) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tthis.db.update({ id: item.id }, item);\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tthis.retrieveOne(item.id).then((updated) => resolve(updated)).catch((err) => reject(err));\n\t\t});\n\t}\n\n\tremove(id) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tthis.db.remove({ id });\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tresolve({ success: true });\n\t\t});\n\t}\n}\n","import { AppsLogsModel } from './apps-logs-model';\nimport { AppsModel } from './apps-model';\nimport { AppsPersistenceModel } from './apps-persistence-model';\nimport { AppRealLogsStorage } from './logs-storage';\nimport { AppRealStorage } from './storage';\n\nexport { AppsLogsModel, AppsModel, AppsPersistenceModel, AppRealLogsStorage, AppRealStorage };\n","import { AppConsole } from '@rocket.chat/apps-engine/server/logging';\nimport { AppLogStorage } from '@rocket.chat/apps-engine/server/storage';\n\nexport class AppRealLogsStorage extends AppLogStorage {\n\tconstructor(model) {\n\t\tsuper('mongodb');\n\t\tthis.db = model;\n\t}\n\n\tfind() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet docs;\n\n\t\t\ttry {\n\t\t\t\tdocs = this.db.find(...arguments).fetch();\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tresolve(docs);\n\t\t});\n\t}\n\n\tstoreEntries(appId, logger) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst item = AppConsole.toStorageEntry(appId, logger);\n\n\t\t\ttry {\n\t\t\t\tconst id = this.db.insert(item);\n\n\t\t\t\tresolve(this.db.findOneById(id));\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetEntriesFor(appId) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet docs;\n\n\t\t\ttry {\n\t\t\t\tdocs = this.db.find({ appId }).fetch();\n\t\t\t} catch (e) {\n\t\t\t\treturn reject(e);\n\t\t\t}\n\n\t\t\tresolve(docs);\n\t\t});\n\t}\n}\n","export class AppActivationBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tappAdded(app) {\n\t\tthis.orch.getNotifier().appAdded(app.getID());\n\t}\n\n\tappUpdated(app) {\n\t\tthis.orch.getNotifier().appUpdated(app.getID());\n\t}\n\n\tappRemoved(app) {\n\t\tthis.orch.getNotifier().appRemoved(app.getID());\n\t}\n\n\tappStatusChanged(app, status) {\n\t\tthis.orch.getNotifier().appStatusUpdated(app.getID(), status);\n\t}\n}\n","import { AppBridges } from '@rocket.chat/apps-engine/server/bridges';\n\nimport { AppActivationBridge } from './activation';\nimport { AppDetailChangesBridge } from './details';\nimport { AppCommandsBridge } from './commands';\nimport { AppEnvironmentalVariableBridge } from './environmental';\nimport { AppHttpBridge } from './http';\nimport { AppMessageBridge } from './messages';\nimport { AppPersistenceBridge } from './persistence';\nimport { AppRoomBridge } from './rooms';\nimport { AppSettingBridge } from './settings';\nimport { AppUserBridge } from './users';\n\nexport class RealAppBridges extends AppBridges {\n\tconstructor(orch) {\n\t\tsuper();\n\n\t\tthis._actBridge = new AppActivationBridge(orch);\n\t\tthis._cmdBridge = new AppCommandsBridge(orch);\n\t\tthis._detBridge = new AppDetailChangesBridge(orch);\n\t\tthis._envBridge = new AppEnvironmentalVariableBridge(orch);\n\t\tthis._httpBridge = new AppHttpBridge();\n\t\tthis._msgBridge = new AppMessageBridge(orch);\n\t\tthis._persistBridge = new AppPersistenceBridge(orch);\n\t\tthis._roomBridge = new AppRoomBridge(orch);\n\t\tthis._setsBridge = new AppSettingBridge(orch);\n\t\tthis._userBridge = new AppUserBridge(orch);\n\t}\n\n\tgetCommandBridge() {\n\t\treturn this._cmdBridge;\n\t}\n\n\tgetEnvironmentalVariableBridge() {\n\t\treturn this._envBridge;\n\t}\n\n\tgetHttpBridge() {\n\t\treturn this._httpBridge;\n\t}\n\n\tgetMessageBridge() {\n\t\treturn this._msgBridge;\n\t}\n\n\tgetPersistenceBridge() {\n\t\treturn this._persistBridge;\n\t}\n\n\tgetAppActivationBridge() {\n\t\treturn this._actBridge;\n\t}\n\n\tgetAppDetailChangesBridge() {\n\t\treturn this._detBridge;\n\t}\n\n\tgetRoomBridge() {\n\t\treturn this._roomBridge;\n\t}\n\n\tgetServerSettingBridge() {\n\t\treturn this._setsBridge;\n\t}\n\n\tgetUserBridge() {\n\t\treturn this._userBridge;\n\t}\n}\n","import { SlashCommandContext } from '@rocket.chat/apps-ts-definition/slashcommands';\n\nexport class AppCommandsBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t\tthis.disabledCommands = new Map();\n\t}\n\n\tdoesCommandExist(command, appId) {\n\t\tconsole.log(`The App ${ appId } is checking if \"${ command }\" command exists.`);\n\n\t\tif (typeof command !== 'string' || command.length === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst cmd = command.toLowerCase();\n\t\treturn typeof RocketChat.slashCommands.commands[cmd] === 'object' || this.disabledCommands.has(cmd);\n\t}\n\n\tenableCommand(command, appId) {\n\t\tconsole.log(`The App ${ appId } is attempting to enable the command: \"${ command }\"`);\n\n\t\tif (typeof command !== 'string' || command.trim().length === 0) {\n\t\t\tthrow new Error('Invalid command parameter provided, must be a string.');\n\t\t}\n\n\t\tconst cmd = command.toLowerCase();\n\t\tif (!this.disabledCommands.has(cmd)) {\n\t\t\tthrow new Error(`The command is not currently disabled: \"${ cmd }\"`);\n\t\t}\n\n\t\tRocketChat.slashCommands.commands[cmd] = this.disabledCommands.get(cmd);\n\t\tthis.disabledCommands.delete(cmd);\n\n\t\tthis.orch.getNotifier().commandUpdated(cmd);\n\t}\n\n\tdisableCommand(command, appId) {\n\t\tconsole.log(`The App ${ appId } is attempting to disable the command: \"${ command }\"`);\n\n\t\tif (typeof command !== 'string' || command.trim().length === 0) {\n\t\t\tthrow new Error('Invalid command parameter provided, must be a string.');\n\t\t}\n\n\t\tconst cmd = command.toLowerCase();\n\t\tif (this.disabledCommands.has(cmd)) {\n\t\t\t// The command is already disabled, no need to disable it yet again\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof RocketChat.slashCommands.commands[cmd] === 'undefined') {\n\t\t\tthrow new Error(`Command does not exist in the system currently: \"${ cmd }\"`);\n\t\t}\n\n\t\tthis.disabledCommands.set(cmd, RocketChat.slashCommands.commands[cmd]);\n\t\tdelete RocketChat.slashCommands.commands[cmd];\n\n\t\tthis.orch.getNotifier().commandDisabled(cmd);\n\t}\n\n\t// command: { command, paramsExample, i18nDescription, executor: function }\n\tmodifyCommand(command, appId) {\n\t\tconsole.log(`The App ${ appId } is attempting to modify the command: \"${ command }\"`);\n\n\t\tthis._verifyCommand(command);\n\n\t\tconst cmd = command.toLowerCase();\n\t\tif (typeof RocketChat.slashCommands.commands[cmd] === 'undefined') {\n\t\t\tthrow new Error(`Command does not exist in the system currently (or it is disabled): \"${ cmd }\"`);\n\t\t}\n\n\t\tconst item = RocketChat.slashCommands.commands[cmd];\n\t\titem.params = command.paramsExample ? command.paramsExample : item.params;\n\t\titem.description = command.i18nDescription ? command.i18nDescription : item.params;\n\t\titem.callback = this._appCommandExecutor.bind(this);\n\n\t\tRocketChat.slashCommands.commands[cmd] = item;\n\t\tthis.orch.getNotifier().commandUpdated(cmd);\n\t}\n\n\tregisterCommand(command, appId) {\n\t\tconsole.log(`The App ${ appId } is registering the command: \"${ command.command }\"`);\n\n\t\tthis._verifyCommand(command);\n\n\t\tconst item = {\n\t\t\tcommand: command.command.toLowerCase(),\n\t\t\tparams: command.paramsExample,\n\t\t\tdescription: command.i18nDescription,\n\t\t\tcallback: this._appCommandExecutor.bind(this)\n\t\t};\n\n\t\tRocketChat.slashCommands.commands[command.command.toLowerCase()] = item;\n\t\tthis.orch.getNotifier().commandAdded(command.command.toLowerCase());\n\t}\n\n\tunregisterCommand(command, appId) {\n\t\tconsole.log(`The App ${ appId } is unregistering the command: \"${ command }\"`);\n\n\t\tif (typeof command !== 'string' || command.trim().length === 0) {\n\t\t\tthrow new Error('Invalid command parameter provided, must be a string.');\n\t\t}\n\n\t\tconst cmd = command.toLowerCase();\n\t\tthis.disabledCommands.delete(cmd);\n\t\tdelete RocketChat.slashCommands.commands[cmd];\n\n\t\tthis.orch.getNotifier().commandRemoved(cmd);\n\t}\n\n\t_verifyCommand(command) {\n\t\tif (typeof command !== 'object') {\n\t\t\tthrow new Error('Invalid Slash Command parameter provided, it must be a valid ISlashCommand object.');\n\t\t}\n\n\t\tif (typeof command.command !== 'string') {\n\t\t\tthrow new Error('Invalid Slash Command parameter provided, it must be a valid ISlashCommand object.');\n\t\t}\n\n\t\tif (command.paramsExample && typeof command.paramsExample !== 'string') {\n\t\t\tthrow new Error('Invalid Slash Command parameter provided, it must be a valid ISlashCommand object.');\n\t\t}\n\n\t\tif (command.i18nDescription && typeof command.i18nDescription !== 'string') {\n\t\t\tthrow new Error('Invalid Slash Command parameter provided, it must be a valid ISlashCommand object.');\n\t\t}\n\n\t\tif (typeof command.executor !== 'function') {\n\t\t\tthrow new Error('Invalid Slash Command parameter provided, it must be a valid ISlashCommand object.');\n\t\t}\n\t}\n\n\t_appCommandExecutor(command, parameters, message) {\n\t\tconst user = this.orch.getConverters().get('users').convertById(Meteor.userId());\n\t\tconst room = this.orch.getConverters().get('rooms').convertById(message.rid);\n\t\tconst params = parameters.length === 0 || parameters === ' ' ? [] : parameters.split(' ');\n\n\t\tconst context = new SlashCommandContext(Object.freeze(user), Object.freeze(room), Object.freeze(params));\n\t\tthis.orch.getManager().getCommandManager().executeCommand(command, context);\n\t}\n}\n","export class AppEnvironmentalVariableBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t\tthis.allowed = ['NODE_ENV', 'ROOT_URL', 'INSTANCE_IP'];\n\t}\n\n\tgetValueByName(envVarName, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the environmental variable value ${ envVarName }.`);\n\n\t\tif (this.isReadable(envVarName, appId)) {\n\t\t\treturn process.env[envVarName];\n\t\t}\n\n\t\tthrow new Error(`The environmental variable \"${ envVarName }\" is not readable.`);\n\t}\n\n\tisReadable(envVarName, appId) {\n\t\tconsole.log(`The App ${ appId } is checking if the environmental variable is readable ${ envVarName }.`);\n\n\t\treturn this.allowed.includes(envVarName.toUpperCase());\n\t}\n\n\tisSet(envVarName, appId) {\n\t\tconsole.log(`The App ${ appId } is checking if the environmental variable is set ${ envVarName }.`);\n\n\t\tif (this.isReadable(envVarName, appId)) {\n\t\t\treturn typeof process.env[envVarName] !== 'undefined';\n\t\t}\n\n\t\tthrow new Error(`The environmental variable \"${ envVarName }\" is not readable.`);\n\t}\n}\n","export class AppMessageBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tcreate(message, appId) {\n\t\tconsole.log(`The App ${ appId } is creating a new message.`);\n\n\t\tlet msg = this.orch.getConverters().get('messages').convertAppMessage(message);\n\n\t\tMeteor.runAsUser(msg.u._id, () => {\n\t\t\tmsg = Meteor.call('sendMessage', msg);\n\t\t});\n\n\t\treturn msg._id;\n\t}\n\n\tgetById(messageId, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the message: \"${ messageId }\"`);\n\n\t\treturn this.orch.getConverters().get('messages').convertById(messageId);\n\t}\n\n\tupdate(message, appId) {\n\t\tconsole.log(`The App ${ appId } is updating a message.`);\n\n\t\tif (!message.editor) {\n\t\t\tthrow new Error('Invalid editor assigned to the message for the update.');\n\t\t}\n\n\t\tif (!message.id || !RocketChat.models.Messages.findOneById(message.id)) {\n\t\t\tthrow new Error('A message must exist to update.');\n\t\t}\n\n\t\tconst msg = this.orch.getConverters().get('messages').convertAppMessage(message);\n\t\tconst editor = RocketChat.models.Users.findOneById(message.editor.id);\n\n\t\tRocketChat.updateMessage(msg, editor);\n\t}\n}\n","export class AppPersistenceBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tpurge(appId) {\n\t\tconsole.log(`The App's persistent storage is being purged: ${ appId }`);\n\n\t\tthis.orch.getPersistenceModel().remove({ appId });\n\t}\n\n\tcreate(data, appId) {\n\t\tconsole.log(`The App ${ appId } is storing a new object in their persistence.`, data);\n\n\t\tif (typeof data !== 'object') {\n\t\t\tthrow new Error('Attempted to store an invalid data type, it must be an object.');\n\t\t}\n\n\t\treturn this.orch.getPersistenceModel().insert({ appId, data });\n\t}\n\n\tcreateWithAssociations(data, associations, appId) {\n\t\tconsole.log(`The App ${ appId } is storing a new object in their persistence that is associated with some models.`, data, associations);\n\n\t\tif (typeof data !== 'object') {\n\t\t\tthrow new Error('Attempted to store an invalid data type, it must be an object.');\n\t\t}\n\n\t\treturn this.orch.getPersistenceModel().insert({ appId, associations, data });\n\t}\n\n\treadById(id, appId) {\n\t\tconsole.log(`The App ${ appId } is reading their data in their persistence with the id: \"${ id }\"`);\n\n\t\tconst record = this.orch.getPersistenceModel().findOneById(id);\n\n\t\treturn record.data;\n\t}\n\n\treadByAssociations(associations, appId) {\n\t\tconsole.log(`The App ${ appId } is searching for records that are associated with the following:`, associations);\n\n\t\tthrow new Error('Not implemented.');\n\t}\n\n\tremove(id, appId) {\n\t\tconsole.log(`The App ${ appId } is removing one of their records by the id: \"${ id }\"`);\n\n\t\tconst record = this.orch.getPersistenceModel().findOneById(id);\n\n\t\tif (!record) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tthis.orch.getPersistenceModel().remove({ _id: id });\n\n\t\treturn record.data;\n\t}\n\n\tremoveByAssociations(associations, appId) {\n\t\tconsole.log(`The App ${ appId } is removing records with the following associations:`, associations);\n\n\t\tthrow new Error('Not implemented.');\n\t}\n\n\tupdate(id, data, upsert, appId) {\n\t\tconsole.log(`The App ${ appId } is updating the record \"${ id }\" to:`, data);\n\n\t\tif (typeof data !== 'object') {\n\t\t\tthrow new Error('Attempted to store an invalid data type, it must be an object.');\n\t\t}\n\n\t\tthrow new Error('Not implemented.');\n\t}\n}\n","import { RoomType } from '@rocket.chat/apps-ts-definition/rooms';\n\nexport class AppRoomBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tcreate(room, appId) {\n\t\tconsole.log(`The App ${ appId } is creating a new room.`, room);\n\n\t\tconst rcRoom = this.orch.getConverters().get('rooms').convertAppRoom(room);\n\t\tlet method;\n\n\t\tswitch (room.type) {\n\t\t\tcase RoomType.CHANNEL:\n\t\t\t\tmethod = 'createChannel';\n\t\t\t\tbreak;\n\t\t\tcase RoomType.PRIVATE_GROUP:\n\t\t\t\tmethod = 'createPrivateGroup';\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Only channels and private groups can be created.');\n\t\t}\n\n\t\tlet rid;\n\t\tMeteor.runAsUser(room.creator.id, () => {\n\t\t\tconst info = Meteor.call(method, rcRoom.usernames);\n\t\t\trid = info.rid;\n\t\t});\n\n\t\treturn rid;\n\t}\n\n\tgetById(roomId, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the roomById: \"${ roomId }\"`);\n\n\t\treturn this.orch.getConverters().get('rooms').convertById(roomId);\n\t}\n\n\tgetByName(roomName, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the roomByName: \"${ roomName }\"`);\n\n\t\treturn this.orch.getConverters().get('rooms').convertByName(roomName);\n\t}\n\n\tupdate(room, appId) {\n\t\tconsole.log(`The App ${ appId } is updating a room.`);\n\n\t\tif (!room.id || RocketChat.models.Rooms.findOneById(room.id)) {\n\t\t\tthrow new Error('A room must exist to update.');\n\t\t}\n\n\t\tconst rm = this.orch.getConverters().get('rooms').convertAppRoom(room);\n\n\t\tRocketChat.models.Rooms.update(rm._id, rm);\n\t}\n}\n","export class AppSettingBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t\tthis.allowedGroups = [];\n\t\tthis.disallowedSettings = [\n\t\t\t'Accounts_RegistrationForm_SecretURL', 'CROWD_APP_USERNAME', 'CROWD_APP_PASSWORD', 'Direct_Reply_Username',\n\t\t\t'Direct_Reply_Password', 'SMTP_Username', 'SMTP_Password', 'FileUpload_S3_AWSAccessKeyId', 'FileUpload_S3_AWSSecretAccessKey',\n\t\t\t'FileUpload_S3_BucketURL', 'FileUpload_GoogleStorage_Bucket', 'FileUpload_GoogleStorage_AccessId',\n\t\t\t'FileUpload_GoogleStorage_Secret', 'GoogleVision_ServiceAccount', 'Allow_Invalid_SelfSigned_Certs', 'GoogleTagManager_id',\n\t\t\t'Bugsnag_api_key', 'LDAP_CA_Cert', 'LDAP_Reject_Unauthorized', 'LDAP_Domain_Search_User', 'LDAP_Domain_Search_Password',\n\t\t\t'Livechat_secret_token', 'Livechat_Knowledge_Apiai_Key', 'AutoTranslate_GoogleAPIKey', 'MapView_GMapsAPIKey',\n\t\t\t'Meta_fb_app_id', 'Meta_google-site-verification', 'Meta_msvalidate01', 'Accounts_OAuth_Dolphin_secret',\n\t\t\t'Accounts_OAuth_Drupal_secret', 'Accounts_OAuth_Facebook_secret', 'Accounts_OAuth_Github_secret', 'API_GitHub_Enterprise_URL',\n\t\t\t'Accounts_OAuth_GitHub_Enterprise_secret', 'API_Gitlab_URL', 'Accounts_OAuth_Gitlab_secret', 'Accounts_OAuth_Google_secret',\n\t\t\t'Accounts_OAuth_Linkedin_secret', 'Accounts_OAuth_Meteor_secret', 'Accounts_OAuth_Twitter_secret', 'API_Wordpress_URL',\n\t\t\t'Accounts_OAuth_Wordpress_secret', 'Push_apn_passphrase', 'Push_apn_key', 'Push_apn_cert', 'Push_apn_dev_passphrase',\n\t\t\t'Push_apn_dev_key', 'Push_apn_dev_cert', 'Push_gcm_api_key', 'Push_gcm_project_number', 'SAML_Custom_Default_cert',\n\t\t\t'SAML_Custom_Default_private_key', 'SlackBridge_APIToken', 'Smarsh_Email', 'SMS_Twilio_Account_SID', 'SMS_Twilio_authToken'\n\t\t];\n\t}\n\n\tgetAll(appId) {\n\t\tconsole.log(`The App ${ appId } is getting all the settings.`);\n\n\t\treturn RocketChat.models.Settings.find({ _id: { $nin: this.disallowedSettings } }).fetch().map((s) => {\n\t\t\tthis.orch.getConverters().get('settings').convertToApp(s);\n\t\t});\n\t}\n\n\tgetOneById(id, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the setting by id ${ id }.`);\n\n\t\tif (!this.isReadableById(id, appId)) {\n\t\t\tthrow new Error(`The setting \"${ id }\" is not readable.`);\n\t\t}\n\n\t\treturn this.orch.getConverters().get('settings').convertById(id);\n\t}\n\n\thideGroup(name, appId) {\n\t\tconsole.log(`The App ${ appId } is hidding the group ${ name }.`);\n\n\t\tthrow new Error('Method not implemented.');\n\t}\n\n\thideSetting(id, appId) {\n\t\tconsole.log(`The App ${ appId } is hidding the setting ${ id }.`);\n\n\t\tif (!this.isReadableById(id, appId)) {\n\t\t\tthrow new Error(`The setting \"${ id }\" is not readable.`);\n\t\t}\n\n\t\tthrow new Error('Method not implemented.');\n\t}\n\n\tisReadableById(id, appId) {\n\t\tconsole.log(`The App ${ appId } is checking if they can read the setting ${ id }.`);\n\n\t\treturn !this.disallowedSettings.includes(id);\n\t}\n\n\tupdateOne(setting, appId) {\n\t\tconsole.log(`The App ${ appId } is updating the setting ${ setting.id } .`);\n\n\t\tif (!this.isReadableById(setting.id, appId)) {\n\t\t\tthrow new Error(`The setting \"${ setting.id }\" is not readable.`);\n\t\t}\n\n\t\tthrow new Error('Method not implemented.');\n\t}\n}\n","export class AppUserBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tgetById(userId, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the userId: \"${ userId }\"`);\n\n\t\treturn this.orch.getConverters().get('users').convertById(userId);\n\t}\n\n\tgetByUsername(username, appId) {\n\t\tconsole.log(`The App ${ appId } is getting the username: \"${ username }\"`);\n\n\t\treturn this.orch.getConverters().get('users').convertByUsername(username);\n\t}\n}\n","import { RealAppBridges } from './bridges';\nimport { AppActivationBridge } from './activation';\nimport { AppCommandsBridge } from './commands';\nimport { AppEnvironmentalVariableBridge } from './environmental';\nimport { AppHttpBridge } from './http';\nimport { AppMessageBridge } from './messages';\nimport { AppPersistenceBridge } from './persistence';\nimport { AppRoomBridge } from './rooms';\nimport { AppSettingBridge } from './settings';\nimport { AppUserBridge } from './users';\n\nexport {\n\tRealAppBridges,\n\tAppActivationBridge,\n\tAppCommandsBridge,\n\tAppEnvironmentalVariableBridge,\n\tAppHttpBridge,\n\tAppMessageBridge,\n\tAppPersistenceBridge,\n\tAppRoomBridge,\n\tAppSettingBridge,\n\tAppUserBridge\n};\n","export class AppDetailChangesBridge {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tonAppSettingsChange(appId, setting) {\n\t\ttry {\n\t\t\tthis.orch.getNotifier().appSettingsChange(appId, setting);\n\t\t} catch (e) {\n\t\t\tconsole.warn('failed to notify about the setting change.', appId);\n\t\t}\n\t}\n}\n","export class AppHttpBridge {\n\tcall(info) {\n\t\tif (!info.request.content && typeof info.request.data === 'object') {\n\t\t\tinfo.request.content = JSON.stringify(info.request.data);\n\t\t}\n\n\t\tconsole.log(`The App ${ info.appId } is requesting from the outter webs:`, info);\n\n\t\ttry {\n\t\t\treturn HTTP.call(info.method, info.url, info.request);\n\t\t} catch (e) {\n\t\t\treturn e.response;\n\t\t}\n\t}\n}\n","export class AppMethods {\n\tconstructor(manager) {\n\t\tthis._manager = manager;\n\n\t\tthis._addMethods();\n\t}\n\n\t_addMethods() {\n\t\tconst manager = this._manager;\n\n\t\tMeteor.methods({\n\t\t\t'apps/is-enabled'() {\n\t\t\t\treturn typeof manager !== 'undefined';\n\t\t\t},\n\n\t\t\t'apps/is-loaded'() {\n\t\t\t\treturn typeof manager !== 'undefined' || manager.areAppsLoaded();\n\t\t\t}\n\t\t});\n\t}\n}\n","export class AppsRestApi {\n\tconstructor(orch, manager) {\n\t\tthis._orch = orch;\n\t\tthis._manager = manager;\n\t\tthis.api = new RocketChat.API.ApiClass({\n\t\t\tversion: 'apps',\n\t\t\tuseDefaultAuth: true,\n\t\t\tprettyJson: false,\n\t\t\tenableCors: false,\n\t\t\tauth: RocketChat.API.getUserAuth()\n\t\t});\n\n\t\tthis.addManagementRoutes();\n\t}\n\n\t_handleFile(request, fileField) {\n\t\tconst Busboy = Npm.require('busboy');\n\t\tconst busboy = new Busboy({ headers: request.headers });\n\n\t\treturn Meteor.wrapAsync((callback) => {\n\t\t\tbusboy.on('file', Meteor.bindEnvironment((fieldname, file) => {\n\t\t\t\tif (fieldname !== fileField) {\n\t\t\t\t\treturn callback(new Meteor.Error('invalid-field', `Expected the field \"${ fileField }\" but got \"${ fieldname }\" instead.`));\n\t\t\t\t}\n\n\t\t\t\tconst fileData = [];\n\t\t\t\tfile.on('data', Meteor.bindEnvironment((data) => {\n\t\t\t\t\tfileData.push(data);\n\t\t\t\t}));\n\n\t\t\t\tfile.on('end', Meteor.bindEnvironment(() => callback(undefined, Buffer.concat(fileData))));\n\t\t\t}));\n\n\t\t\trequest.pipe(busboy);\n\t\t})();\n\t}\n\n\taddManagementRoutes() {\n\t\tconst orchestrator = this._orch;\n\t\tconst manager = this._manager;\n\t\tconst fileHandler = this._handleFile;\n\n\t\tthis.api.addRoute('', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconst apps = manager.get().map(prl => {\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tinfo.languages = prl.getStorageItem().languageContent;\n\t\t\t\t\tinfo.status = prl.getStatus();\n\n\t\t\t\t\treturn info;\n\t\t\t\t});\n\n\t\t\t\treturn RocketChat.API.v1.success({ apps });\n\t\t\t},\n\t\t\tpost() {\n\t\t\t\tlet buff;\n\n\t\t\t\tif (this.bodyParams.url) {\n\t\t\t\t\tconst result = HTTP.call('GET', this.bodyParams.url, { npmRequestOptions: { encoding: 'base64' }});\n\n\t\t\t\t\tif (result.statusCode !== 200 || !result.headers['content-type'] || result.headers['content-type'] !== 'application/zip') {\n\t\t\t\t\t\treturn RocketChat.API.v1.failure({ error: 'Invalid url. It doesn\\'t exist or is not \"application/zip\".' });\n\t\t\t\t\t}\n\n\t\t\t\t\tbuff = Buffer.from(result.content, 'base64');\n\t\t\t\t} else {\n\t\t\t\t\tbuff = fileHandler(this.request, 'app');\n\t\t\t\t}\n\n\t\t\t\tif (!buff) {\n\t\t\t\t\treturn RocketChat.API.v1.failure({ error: 'Failed to get a file to install for the App. '});\n\t\t\t\t}\n\n\t\t\t\tconst item = Meteor.wrapAsync((callback) => {\n\t\t\t\t\tmanager.add(buff.toString('base64'), false).then((rl) => callback(undefined, rl)).catch((e) => {\n\t\t\t\t\t\tconsole.warn('Error!', e);\n\t\t\t\t\t\tcallback(e);\n\t\t\t\t\t});\n\t\t\t\t})();\n\n\t\t\t\tconst info = item.getInfo();\n\t\t\t\tinfo.status = item.getStatus();\n\n\t\t\t\treturn RocketChat.API.v1.success({ app: info });\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute('languages', { authRequired: false }, {\n\t\t\tget() {\n\t\t\t\tconst apps = manager.get().map(prl => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: prl.getID(),\n\t\t\t\t\t\tlanguages: prl.getStorageItem().languageContent\n\t\t\t\t\t};\n\t\t\t\t});\n\n\t\t\t\treturn RocketChat.API.v1.success({ apps });\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log('Getting:', this.urlParams.id);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tinfo.status = prl.getStatus();\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ app: info });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t},\n\t\t\tpost() {\n\t\t\t\tconsole.log('Updating:', this.urlParams.id);\n\t\t\t\t// TODO: Verify permissions\n\n\t\t\t\tconst buff = fileHandler(this.request, 'app');\n\t\t\t\tconst item = Meteor.wrapAsync((callback) => {\n\t\t\t\t\tmanager.update(buff.toString('base64')).then((rl) => callback(rl)).catch((e) => callback(e));\n\t\t\t\t});\n\n\t\t\t\tconst info = item.getInfo();\n\t\t\t\tinfo.status = item.getStatus();\n\n\t\t\t\treturn RocketChat.API.v1.success({ app: info });\n\t\t\t},\n\t\t\tdelete() {\n\t\t\t\tconsole.log('Uninstalling:', this.urlParams.id);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tPromise.await(manager.remove(prl.getID()));\n\n\t\t\t\t\tconst info = prl.getInfo();\n\t\t\t\t\tinfo.status = prl.getStatus();\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ app: info });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/icon', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log('Getting the App\\'s Icon:', this.urlParams.id);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst info = prl.getInfo();\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ iconFileContent: info.iconFileContent });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/languages', { authRequired: false }, {\n\t\t\tget() {\n\t\t\t\tconsole.log(`Getting ${ this.urlParams.id }'s languages..`);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst languages = prl.getStorageItem().languageContent || {};\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ languages });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/logs', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log(`Getting ${ this.urlParams.id }'s logs..`);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst { offset, count } = this.getPaginationItems();\n\t\t\t\t\tconst { sort, fields, query } = this.parseJsonQuery();\n\n\t\t\t\t\tconst ourQuery = Object.assign({}, query, { appId: prl.getID() });\n\t\t\t\t\tconst options = {\n\t\t\t\t\t\tsort: sort ? sort : { _updatedAt: -1 },\n\t\t\t\t\t\tskip: offset,\n\t\t\t\t\t\tlimit: count,\n\t\t\t\t\t\tfields\n\t\t\t\t\t};\n\n\t\t\t\t\tconst logs = Promise.await(orchestrator.getLogStorage().find(ourQuery, options));\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ logs });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/settings', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log(`Getting ${ this.urlParams.id }'s settings..`);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst settings = Object.assign({}, prl.getStorageItem().settings);\n\n\t\t\t\t\tObject.keys(settings).forEach((k) => {\n\t\t\t\t\t\tif (settings[k].hidden) {\n\t\t\t\t\t\t\tdelete settings[k];\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ settings });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t},\n\t\t\tpost() {\n\t\t\t\tconsole.log(`Updating ${ this.urlParams.id }'s settings..`);\n\t\t\t\tif (!this.bodyParams || !this.bodyParams.settings) {\n\t\t\t\t\treturn RocketChat.API.v1.failure('The settings to update must be present.');\n\t\t\t\t}\n\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (!prl) {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\n\t\t\t\tconst settings = prl.getStorageItem().settings;\n\n\t\t\t\tconst updated = [];\n\t\t\t\tthis.bodyParams.settings.forEach((s) => {\n\t\t\t\t\tif (settings[s.id]) {\n\t\t\t\t\t\tPromise.await(manager.getSettingsManager().updateAppSetting(this.urlParams.id, s));\n\t\t\t\t\t\t// Updating?\n\t\t\t\t\t\tupdated.push(s);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\treturn RocketChat.API.v1.success({ updated });\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/settings/:settingId', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log(`Getting the App ${ this.urlParams.id }'s setting ${ this.urlParams.settingId }`);\n\n\t\t\t\ttry {\n\t\t\t\t\tconst setting = manager.getSettingsManager().getAppSetting(this.urlParams.id, this.urlParams.settingId);\n\n\t\t\t\t\tRocketChat.API.v1.success({ setting });\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\treturn RocketChat.API.v1.notFound(`No Setting found on the App by the id of: \"${ this.urlParams.settingId }\"`);\n\t\t\t\t\t} else if (e.message.includes('No App found')) {\n\t\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tpost() {\n\t\t\t\tconsole.log(`Updating the App ${ this.urlParams.id }'s setting ${ this.urlParams.settingId }`);\n\n\t\t\t\tif (!this.bodyParams.setting) {\n\t\t\t\t\treturn RocketChat.API.v1.failure('Setting to update to must be present on the posted body.');\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tPromise.await(manager.getSettingsManager().updateAppSetting(this.urlParams.id, this.bodyParams.setting));\n\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (e.message.includes('No setting found')) {\n\t\t\t\t\t\treturn RocketChat.API.v1.notFound(`No Setting found on the App by the id of: \"${ this.urlParams.settingId }\"`);\n\t\t\t\t\t} else if (e.message.includes('No App found')) {\n\t\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.api.addRoute(':id/status', { authRequired: true }, {\n\t\t\tget() {\n\t\t\t\tconsole.log(`Getting ${ this.urlParams.id }'s status..`);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ status: prl.getStatus() });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t},\n\t\t\tpost() {\n\t\t\t\tif (!this.bodyParams.status || typeof this.bodyParams.status !== 'string') {\n\t\t\t\t\treturn RocketChat.API.v1.failure('Invalid status provided, it must be \"status\" field and a string.');\n\t\t\t\t}\n\n\t\t\t\tconsole.log(`Updating ${ this.urlParams.id }'s status...`, this.bodyParams.status);\n\t\t\t\tconst prl = manager.getOneById(this.urlParams.id);\n\n\t\t\t\tif (prl) {\n\t\t\t\t\tconst result = Promise.await(manager.changeStatus(prl.getID(), this.bodyParams.status));\n\n\t\t\t\t\treturn RocketChat.API.v1.success({ status: result.getStatus() });\n\t\t\t\t} else {\n\t\t\t\t\treturn RocketChat.API.v1.notFound(`No App found by the id of: ${ this.urlParams.id }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n","import { AppStatus, AppStatusUtils } from '@rocket.chat/apps-ts-definition/AppStatus';\n\nexport const AppEvents = Object.freeze({\n\tAPP_ADDED: 'app/added',\n\tAPP_REMOVED: 'app/removed',\n\tAPP_UPDATED: 'app/updated',\n\tAPP_STATUS_CHANGE: 'app/statusUpdate',\n\tAPP_SETTING_UPDATED: 'app/settingUpdated',\n\tCOMMAND_ADDED: 'command/added',\n\tCOMMAND_DISABLED: 'command/disabled',\n\tCOMMAND_UPDATED: 'command/updated',\n\tCOMMAND_REMOVED: 'command/removed'\n});\n\nexport class AppServerListener {\n\tconstructor(orch, engineStreamer, clientStreamer, recieved) {\n\t\tthis.orch = orch;\n\t\tthis.engineStreamer = engineStreamer;\n\t\tthis.clientStreamer = clientStreamer;\n\t\tthis.recieved = recieved;\n\n\t\tthis.engineStreamer.on(AppEvents.APP_ADDED, this.onAppAdded.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.APP_STATUS_CHANGE, this.onAppStatusUpdated.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.APP_SETTING_UPDATED, this.onAppSettingUpdated.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.APP_REMOVED, this.onAppRemoved.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.COMMAND_ADDED, this.onCommandAdded.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.COMMAND_DISABLED, this.onCommandDisabled.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.COMMAND_UPDATED, this.onCommandUpdated.bind(this));\n\t\tthis.engineStreamer.on(AppEvents.COMMAND_REMOVED, this.onCommandRemoved.bind(this));\n\t}\n\n\tonAppAdded(appId) {\n\t\tthis.orch.getManager().loadOne(appId).then(() => this.clientStreamer.emit(AppEvents.APP_ADDED, appId));\n\t}\n\n\tonAppStatusUpdated({ appId, status }) {\n\t\tthis.recieved.set(`${ AppEvents.APP_STATUS_CHANGE }_${ appId }`, { appId, status, when: new Date() });\n\n\t\tif (AppStatusUtils.isEnabled(status)) {\n\t\t\tthis.orch.getManager().enable(appId)\n\t\t\t\t.then(() => this.clientStreamer.emit(AppEvents.APP_STATUS_CHANGE, { appId, status }));\n\t\t} else if (AppStatusUtils.isDisabled(status)) {\n\t\t\tthis.orch.getManager().disable(appId, AppStatus.MANUALLY_DISABLED === status)\n\t\t\t\t.then(() => this.clientStreamer.emit(AppEvents.APP_STATUS_CHANGE, { appId, status }));\n\t\t}\n\t}\n\n\tonAppSettingUpdated({ appId, setting }) {\n\t\tthis.recieved.set(`${ AppEvents.APP_SETTING_UPDATED }_${ appId }_${ setting.id }`, { appId, setting, when: new Date() });\n\n\t\tthis.orch.getManager().getSettingsManager().updateAppSetting(appId, setting)\n\t\t\t.then(() => this.clientStreamer.emit(AppEvents.APP_SETTING_UPDATED, { appId }));\n\t}\n\n\tonAppRemoved(appId) {\n\t\tthis.orch.getManager().remove(appId).then(() => this.clientStreamer.emit(AppEvents.APP_REMOVED, appId));\n\t}\n\n\tonCommandAdded(command) {\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_ADDED, command);\n\t}\n\n\tonCommandDisabled(command) {\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_DISABLED, command);\n\t}\n\n\tonCommandUpdated(command) {\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_UPDATED, command);\n\t}\n\n\tonCommandRemoved(command) {\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_REMOVED, command);\n\t}\n}\n\nexport class AppServerNotifier {\n\tconstructor(orch) {\n\t\tthis.engineStreamer = new Meteor.Streamer('apps-engine', { retransmit: false });\n\t\tthis.engineStreamer.serverOnly = true;\n\t\tthis.engineStreamer.allowRead('none');\n\t\tthis.engineStreamer.allowEmit('all');\n\t\tthis.engineStreamer.allowWrite('none');\n\n\t\t// This is used to broadcast to the web clients\n\t\tthis.clientStreamer = new Meteor.Streamer('apps', { retransmit: false });\n\t\tthis.clientStreamer.serverOnly = true;\n\t\tthis.clientStreamer.allowRead('all');\n\t\tthis.clientStreamer.allowEmit('all');\n\t\tthis.clientStreamer.allowWrite('none');\n\n\t\tthis.recieved = new Map();\n\t\tthis.listener = new AppServerListener(orch, this.engineStreamer, this.clientStreamer, this.recieved);\n\t}\n\n\tappAdded(appId) {\n\t\tthis.engineStreamer.emit(AppEvents.APP_ADDED, appId);\n\t\tthis.clientStreamer.emit(AppEvents.APP_ADDED, appId);\n\t}\n\n\tappRemoved(appId) {\n\t\tthis.engineStreamer.emit(AppEvents.APP_REMOVED, appId);\n\t\tthis.clientStreamer.emit(AppEvents.APP_REMOVED, appId);\n\t}\n\n\tappUpdated(appId) {\n\t\tthis.engineStreamer.emit(AppEvents.APP_UPDATED, appId);\n\t\tthis.clientStreamer.emit(AppEvents.APP_UPDATED, appId);\n\t}\n\n\tappStatusUpdated(appId, status) {\n\t\tif (this.recieved.has(`${ AppEvents.APP_STATUS_CHANGE }_${ appId }`)) {\n\t\t\tconst details = this.recieved.get(`${ AppEvents.APP_STATUS_CHANGE }_${ appId }`);\n\t\t\tif (details.status === status) {\n\t\t\t\tthis.recieved.delete(`${ AppEvents.APP_STATUS_CHANGE }_${ appId }`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.engineStreamer.emit(AppEvents.APP_STATUS_CHANGE, { appId, status });\n\t\tthis.clientStreamer.emit(AppEvents.APP_STATUS_CHANGE, { appId, status });\n\t}\n\n\tappSettingsChange(appId, setting) {\n\t\tif (this.recieved.has(`${ AppEvents.APP_SETTING_UPDATED }_${ appId }_${ setting.id }`)) {\n\t\t\tthis.recieved.delete(`${ AppEvents.APP_SETTING_UPDATED }_${ appId }_${ setting.id }`);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.engineStreamer.emit(AppEvents.APP_SETTING_UPDATED, { appId, setting });\n\t\tthis.clientStreamer.emit(AppEvents.APP_SETTING_UPDATED, { appId });\n\t}\n\n\tcommandAdded(command) {\n\t\tthis.engineStreamer.emit(AppEvents.COMMAND_ADDED, command);\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_ADDED, command);\n\t}\n\n\tcommandDisabled(command) {\n\t\tthis.engineStreamer.emit(AppEvents.COMMAND_DISABLED, command);\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_DISABLED, command);\n\t}\n\n\tcommandUpdated(command) {\n\t\tthis.engineStreamer.emit(AppEvents.COMMAND_UPDATED, command);\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_UPDATED, command);\n\t}\n\n\tcommandRemoved(command) {\n\t\tthis.engineStreamer.emit(AppEvents.COMMAND_REMOVED, command);\n\t\tthis.clientStreamer.emit(AppEvents.COMMAND_REMOVED, command);\n\t}\n}\n","import { AppMethods} from './methods';\nimport { AppsRestApi } from './rest';\nimport { AppEvents, AppServerNotifier, AppServerListener } from './websockets';\n\nexport {\n\tAppMethods,\n\tAppsRestApi,\n\tAppEvents,\n\tAppServerNotifier,\n\tAppServerListener\n};\n","export class AppMessagesConverter {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tconvertById(msgId) {\n\t\tconst msg = RocketChat.models.Messages.getOneById(msgId);\n\n\t\treturn this.convertMessage(msg);\n\t}\n\n\tconvertMessage(msgObj) {\n\t\tif (!msgObj) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst room = this.orch.getConverters().get('rooms').convertById(msgObj.rid);\n\t\tconst sender = this.orch.getConverters().get('users').convertById(msgObj.u._id);\n\n\t\tlet editor;\n\t\tif (msgObj.editedBy) {\n\t\t\teditor = this.orch.getConverters().get('users').convertById(msgObj.editedBy._id);\n\t\t}\n\n\t\tconst attachments = this._convertAttachmentsToApp(msgObj.attachments);\n\n\t\treturn {\n\t\t\tid: msgObj._id,\n\t\t\troom,\n\t\t\tsender,\n\t\t\ttext: msgObj.msg,\n\t\t\tcreatedAt: msgObj.ts,\n\t\t\tupdatedAt: msgObj._updatedAt,\n\t\t\teditor,\n\t\t\teditedAt: msgObj.editedAt,\n\t\t\temoji: msgObj.emoji,\n\t\t\tavatarUrl: msgObj.avatar,\n\t\t\talias: msgObj.alias,\n\t\t\tcustomFields: msgObj.customFields,\n\t\t\tattachments\n\t\t};\n\t}\n\n\tconvertAppMessage(message) {\n\t\tif (!message) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(message.room.id);\n\t\tconst user = RocketChat.models.Users.findOneById(message.sender.id);\n\n\t\tif (!room || !user) {\n\t\t\tthrow new Error('Invalid user or room provided on the message.');\n\t\t}\n\n\t\tlet editedBy;\n\t\tif (message.editor) {\n\t\t\tconst editor = RocketChat.models.Users.findOneById(message.editor.id);\n\t\t\teditedBy = {\n\t\t\t\t_id: editor._id,\n\t\t\t\tusername: editor.username\n\t\t\t};\n\t\t}\n\n\t\tconst attachments = this._convertAppAttachments(message.attachments);\n\n\t\treturn {\n\t\t\t_id: message.id || Random.id(),\n\t\t\trid: room._id,\n\t\t\tu: {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t},\n\t\t\tmsg: message.text,\n\t\t\tts: message.createdAt || new Date(),\n\t\t\t_updatedAt: message.updatedAt || new Date(),\n\t\t\teditedBy,\n\t\t\teditedAt: message.editedAt,\n\t\t\temoji: message.emoji,\n\t\t\tavatar: message.avatarUrl,\n\t\t\talias: message.alias,\n\t\t\tcustomFields: message.customFields,\n\t\t\tattachments\n\t\t};\n\t}\n\n\t_convertAppAttachments(attachments) {\n\t\tif (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn attachments.map((attachment) => {\n\t\t\treturn {\n\t\t\t\tcollapsed: attachment.collapsed,\n\t\t\t\tcolor: attachment.color,\n\t\t\t\ttext: attachment.text,\n\t\t\t\tts: attachment.timestamp,\n\t\t\t\tmessage_link: attachment.timestampLink,\n\t\t\t\tthumb_url: attachment.thumbnailUrl,\n\t\t\t\tauthor_name: attachment.author ? attachment.author.name : undefined,\n\t\t\t\tauthor_link: attachment.author ? attachment.author.link : undefined,\n\t\t\t\tauthor_icon: attachment.author ? attachment.author.icon : undefined,\n\t\t\t\ttitle: attachment.title ? attachment.title.value : undefined,\n\t\t\t\ttitle_link: attachment.title ? attachment.title.link : undefined,\n\t\t\t\ttitle_link_download: attachment.title ? attachment.title.downloadLink : undefined,\n\t\t\t\timage_url: attachment.imageUrl,\n\t\t\t\taudio_url: attachment.audioUrl,\n\t\t\t\tvideo_url: attachment.videoUrl,\n\t\t\t\tfields: attachment.fields\n\t\t\t};\n\t\t});\n\t}\n\n\t_convertAttachmentsToApp(attachments) {\n\t\tif (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn attachments.map((attachment) => {\n\t\t\tlet author;\n\t\t\tif (attachment.author_name || attachment.author_link || attachment.author_icon) {\n\t\t\t\tauthor = {\n\t\t\t\t\tname: attachment.author_name,\n\t\t\t\t\tlink: attachment.author_link,\n\t\t\t\t\ticon: attachment.author_icon\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tlet title;\n\t\t\tif (attachment.title || attachment.title_link || attachment.title_link_download) {\n\t\t\t\ttitle = {\n\t\t\t\t\tvalue: attachment.title,\n\t\t\t\t\tlink: attachment.title_link,\n\t\t\t\t\tdownloadLink: attachment.title_link_download\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tcollapsed: attachment.collapsed,\n\t\t\t\tcolor: attachment.color,\n\t\t\t\ttext: attachment.text,\n\t\t\t\ttimestamp: attachment.ts,\n\t\t\t\ttimestampLink: attachment.message_link,\n\t\t\t\tthumbnailUrl: attachment.thumb_url,\n\t\t\t\tauthor,\n\t\t\t\ttitle,\n\t\t\t\timageUrl: attachment.image_url,\n\t\t\t\taudioUrl: attachment.audio_url,\n\t\t\t\tvideoUrl: attachment.video_url,\n\t\t\t\tfields: attachment.fields\n\t\t\t};\n\t\t});\n\t}\n}\n","import { RoomType } from '@rocket.chat/apps-ts-definition/rooms';\n\nexport class AppRoomsConverter {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tconvertById(roomId) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\treturn this._convertToApp(room);\n\t}\n\n\tconvertByName(roomName) {\n\t\tconst room = RocketChat.models.Rooms.findOneByName(roomName);\n\n\t\treturn this._convertToApp(room);\n\t}\n\n\tconvertAppRoom(room) {\n\t\tif (!room) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst creator = RocketChat.models.Users.findOneById(room.creator.id);\n\n\t\treturn {\n\t\t\t_id: room.id,\n\t\t\tu: {\n\t\t\t\t_id: creator._id,\n\t\t\t\tusername: creator.username\n\t\t\t},\n\t\t\tts: room.createdAt,\n\t\t\tt: room.type,\n\t\t\tname: room.name,\n\t\t\tmsgs: room.messageCount || 0,\n\t\t\tdefault: typeof room.isDefault === 'undefined' ? false : room.isDefault,\n\t\t\t_updatedAt: room.updatedAt,\n\t\t\tlm: room.lastModifiedAt,\n\t\t\tusernames: room.usernames\n\t\t};\n\t}\n\n\t_convertToApp(room) {\n\t\tif (!room) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet creator;\n\t\tif (room.u) {\n\t\t\tcreator = this.orch.getConverters().get('users').convertById(room.u._id);\n\t\t}\n\n\t\treturn {\n\t\t\tid: room._id,\n\t\t\tname: room.name,\n\t\t\ttype: this._convertTypeToApp(room.t),\n\t\t\tcreator,\n\t\t\tusernames: room.usernames,\n\t\t\tisDefault: typeof room.default === 'undefined' ? false : room.default,\n\t\t\tmessageCount: room.msgs,\n\t\t\tcreatedAt: room.ts,\n\t\t\tupdatedAt: room._updatedAt,\n\t\t\tlastModifiedAt: room.lm\n\t\t};\n\t}\n\n\t_convertTypeToApp(typeChar) {\n\t\tswitch (typeChar) {\n\t\t\tcase 'c':\n\t\t\t\treturn RoomType.CHANNEL;\n\t\t\tcase 'p':\n\t\t\t\treturn RoomType.PRIVATE_GROUP;\n\t\t\tcase 'd':\n\t\t\t\treturn RoomType.DIRECT_MESSAGE;\n\t\t\tcase 'lc':\n\t\t\t\treturn RoomType.LIVE_CHAT;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unknown room type of: \"${ typeChar }\"`);\n\t\t}\n\t}\n}\n","import { SettingType } from '@rocket.chat/apps-ts-definition/settings';\n\nexport class AppSettingsConverter {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tconvertById(settingId) {\n\t\tconst setting = RocketChat.models.Settings.findOneById(settingId);\n\n\t\treturn this.convertToApp(setting);\n\t}\n\n\tconvertToApp(setting) {\n\t\treturn {\n\t\t\tid: setting._id,\n\t\t\ttype: this._convertTypeToApp(setting.type),\n\t\t\tpackageValue: setting.packageValue,\n\t\t\tvalues: setting.values,\n\t\t\tvalue: setting.value,\n\t\t\tpublic: setting.public,\n\t\t\thidden: setting.hidden,\n\t\t\tgroup: setting.group,\n\t\t\ti18nLabel: setting.i18nLabel,\n\t\t\ti18nDescription: setting.i18nDescription,\n\t\t\tcreatedAt: setting.ts,\n\t\t\tupdatedAt: setting._updatedAt\n\t\t};\n\t}\n\n\t_convertTypeToApp(type) {\n\t\tswitch (type) {\n\t\t\tcase 'boolean':\n\t\t\t\treturn SettingType.BOOLEAN;\n\t\t\tcase 'code':\n\t\t\t\treturn SettingType.CODE;\n\t\t\tcase 'color':\n\t\t\t\treturn SettingType.COLOR;\n\t\t\tcase 'font':\n\t\t\t\treturn SettingType.FONT;\n\t\t\tcase 'int':\n\t\t\t\treturn SettingType.NUMBER;\n\t\t\tcase 'select':\n\t\t\t\treturn SettingType.SELECT;\n\t\t\tcase 'string':\n\t\t\t\treturn SettingType.STRING;\n\t\t\tdefault:\n\t\t\t\treturn type;\n\t\t}\n\t}\n}\n","import { UserStatusConnection, UserType } from '@rocket.chat/apps-ts-definition/users';\n\nexport class AppUsersConverter {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tconvertById(userId) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\n\t\treturn this._convertToApp(user);\n\t}\n\n\tconvertByUsername(username) {\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username);\n\n\t\treturn this._convertToApp(user);\n\t}\n\n\t_convertToApp(user) {\n\t\tif (!user) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst type = this._convertUserTypeToEnum(user.type);\n\t\tconst status = this._convertStatusConnectionToEnum(user.status);\n\t\tconst statusConnection = this._convertStatusConnectionToEnum(user.statusConnection);\n\n\t\treturn {\n\t\t\tid: user._id,\n\t\t\tusername: user.username,\n\t\t\temails: user.emails,\n\t\t\ttype,\n\t\t\tisEnabled: user.active,\n\t\t\tname: user.name,\n\t\t\troles: user.roles,\n\t\t\tstatus,\n\t\t\tstatusConnection,\n\t\t\tutcOffset: user.utcOffset,\n\t\t\tcreatedAt: user.createdAt,\n\t\t\tupdatedAt: user._updatedAt,\n\t\t\tlastLoginAt: user.lastLogin\n\t\t};\n\t}\n\n\t_convertUserTypeToEnum(type) {\n\t\tswitch (type) {\n\t\t\tcase 'user':\n\t\t\t\treturn UserType.USER;\n\t\t\tcase 'bot':\n\t\t\t\treturn UserType.BOT;\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Unknown user type of:', type);\n\t\t}\n\t}\n\n\t_convertStatusConnectionToEnum(status) {\n\t\tswitch (status) {\n\t\t\tcase 'offline':\n\t\t\t\treturn UserStatusConnection.OFFLINE;\n\t\t\tcase 'online':\n\t\t\t\treturn UserStatusConnection.ONLINE;\n\t\t\tcase 'away':\n\t\t\t\treturn UserStatusConnection.AWAY;\n\t\t\tcase 'busy':\n\t\t\t\treturn UserStatusConnection.BUSY;\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Unknown status type of:', status);\n\t\t}\n\t}\n}\n","import { AppMessagesConverter } from './messages';\nimport { AppRoomsConverter } from './rooms';\nimport { AppSettingsConverter } from './settings';\nimport { AppUsersConverter } from './users';\n\nexport {\n\tAppMessagesConverter,\n\tAppRoomsConverter,\n\tAppSettingsConverter,\n\tAppUsersConverter\n};\n","import { RealAppBridges } from './bridges';\nimport { AppMethods, AppsRestApi, AppServerNotifier } from './communication';\nimport { AppMessagesConverter, AppRoomsConverter, AppSettingsConverter, AppUsersConverter } from './converters';\nimport { AppsLogsModel, AppsModel, AppsPersistenceModel, AppRealStorage, AppRealLogsStorage } from './storage';\n\nimport { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\n\nclass AppServerOrchestrator {\n\tconstructor() {\n\t\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\t\tRocketChat.models.Permissions.createOrUpdate('manage-apps', ['admin']);\n\t\t}\n\n\t\tthis._model = new AppsModel();\n\t\tthis._logModel = new AppsLogsModel();\n\t\tthis._persistModel = new AppsPersistenceModel();\n\t\tthis._storage = new AppRealStorage(this._model);\n\t\tthis._logStorage = new AppRealLogsStorage(this._persistModel);\n\n\t\tthis._converters = new Map();\n\t\tthis._converters.set('messages', new AppMessagesConverter(this));\n\t\tthis._converters.set('rooms', new AppRoomsConverter(this));\n\t\tthis._converters.set('settings', new AppSettingsConverter(this));\n\t\tthis._converters.set('users', new AppUsersConverter(this));\n\n\t\tthis._bridges = new RealAppBridges(this);\n\n\t\tthis._manager = new AppManager(this._storage, this._logStorage, this._bridges);\n\n\t\tthis._communicators = new Map();\n\t\tthis._communicators.set('methods', new AppMethods(this._manager));\n\t\tthis._communicators.set('notifier', new AppServerNotifier(this));\n\t\tthis._communicators.set('restapi', new AppsRestApi(this, this._manager));\n\t}\n\n\tgetModel() {\n\t\treturn this._model;\n\t}\n\n\tgetPersistenceModel() {\n\t\treturn this._persistModel;\n\t}\n\n\tgetStorage() {\n\t\treturn this._storage;\n\t}\n\n\tgetLogStorage() {\n\t\treturn this._logStorage;\n\t}\n\n\tgetConverters() {\n\t\treturn this._converters;\n\t}\n\n\tgetBridges() {\n\t\treturn this._bridges;\n\t}\n\n\tgetNotifier() {\n\t\treturn this._communicators.get('notifier');\n\t}\n\n\tgetManager() {\n\t\treturn this._manager;\n\t}\n}\n\nMeteor.startup(function _appServerOrchestrator() {\n\t// Ensure that everything is setup\n\tif (process.env[AppManager.ENV_VAR_NAME_FOR_ENABLING] !== 'true' && process.env[AppManager.SUPER_FUN_ENV_ENABLEMENT_NAME] !== 'true') {\n\t\treturn new AppMethods();\n\t}\n\n\tconsole.log('Orchestrating the app piece...');\n\tglobal.Apps = new AppServerOrchestrator();\n\n\tglobal.Apps.getManager().load()\n\t\t.then(() => console.log('...done! ;)'))\n\t\t.catch((err) => console.warn('...failed!', err));\n});\n"]}