{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js"],"names":["filesize","module","watch","require","default","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","key","value","parseInt","e","Settings","packageValue","_","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","update","hasPermission","remove","FileUploadBase","constructor","store","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","sharp","Cookies","cookie","Object","assign","handlers","configureUploadsStore","split","pop","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","onRead","fileId","req","res","requestCanAccessFiles","writeHead","setHeader","encodeURIComponent","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","tempFilePath","getTempFilePath","height","future","s","rotate","metadata","bindEnvironment","toFormat","format","jpeg","resize","Math","min","width","pipe","background","embed","toBuffer","then","outputBuffer","writeFile","console","error","lstatSync","getCollection","direct","$set","return","wait","resizeImagePreview","addExtensionTo","image","getStore","_store","getReadStream","transformer","max","blur","result","out","toString","tmpFile","fut","identify","orientation","toFile","unlink","rename","catch","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","lookup","ext","extension","RegExp","modelName","storageType","handlerName","getStoreByName","next","end","getModelFromName","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","getFilter","check","create","token","createToken","createWriteStream","Buffer","writeFileSync","call","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","undefined","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","originalUrl","proxy","request","proxy_res","use","public","sandstorm","configStore","debounce","log","https","fileUrl","getRedirectURL","fileRes","AmazonS3Uploads","AmazonS3Avatars","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","accessKeyId","secretAccessKey","signatureVersion","s3ForcePathStyle","params","ACL","region","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","FileSystemAvatars","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","forEach","on","onReadError","emit","accept","transformRead","range","out_of_range","removeHeader","createGzip","createDeflate","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","methods","roomId","msgData","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","encodeURI","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","image_preview","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","protectedFiles","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","private","multiline","AmazonS3Store","S3","Store","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","writeStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","ContentDisposition","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","contentType","contentDisposition"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize >= -1 && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\t// -1 maxFileSize means there is no limit\n\t\tif (maxFileSize >= -1 && file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (maxFileSize > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\ttry {\n\t\tmaxFileSize = parseInt(value);\n\t} catch (e) {\n\t\tmaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').packageValue;\n\t}\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\nimport _ from 'underscore';\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\treturn userId || (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0); // allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\nimport sharp from 'sharp';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tempFilePath = UploadFS.getTempFilePath(file._id);\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst future = new Future();\n\n\t\tconst s = sharp(tempFilePath);\n\t\ts.rotate();\n\t\t// Get metadata to resize the image the first time to keep \"inside\" the dimensions\n\t\t// then resize again to create the canvas around\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\ts.toFormat(sharp.format.jpeg)\n\t\t\t\t.resize(Math.min(height, metadata.width), Math.min(height, metadata.height))\n\t\t\t\t.pipe(sharp()\n\t\t\t\t\t.resize(height, height)\n\t\t\t\t\t.background('#FFFFFF')\n\t\t\t\t\t.embed()\n\t\t\t\t)\n\t\t\t\t// Use buffer to get the result in memory then replace the existing file\n\t\t\t\t// There is no option to override a file using this library\n\t\t\t\t.toBuffer()\n\t\t\t\t.then(Meteor.bindEnvironment(outputBuffer => {\n\t\t\t\t\tfs.writeFile(tempFilePath, outputBuffer, Meteor.bindEnvironment(err => {\n\t\t\t\t\t\tif (err != null) {\n\t\t\t\t\t\t\tconsole.error(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst size = fs.lstatSync(tempFilePath).size;\n\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\t\t\tfuture.return();\n\t\t\t\t\t}));\n\t\t\t\t}));\n\t\t}));\n\n\t\treturn future.wait();\n\t},\n\n\tresizeImagePreview(file) {\n\t\tfile = RocketChat.models.Uploads.findOneById(file._id);\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst image = FileUpload.getStore('Uploads')._store.getReadStream(file._id, file);\n\n\t\tconst transformer = sharp()\n\t\t\t.resize(32, 32)\n\t\t\t.max()\n\t\t\t.jpeg()\n\t\t\t.blur();\n\t\tconst result = transformer.toBuffer().then((out) => out.toString('base64'));\n\t\timage.pipe(transformer);\n\t\treturn result;\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (!/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst s = sharp(tmpFile);\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tconst identify = {\n\t\t\t\tformat: metadata.format,\n\t\t\t\tsize: {\n\t\t\t\t\twidth: metadata.width,\n\t\t\t\t\theight: metadata.height\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (metadata.orientation == null) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\ts.rotate()\n\t\t\t\t.toFile(`${ tmpFile }.tmp`)\n\t\t\t\t.then(Meteor.bindEnvironment(() => {\n\t\t\t\t\tfs.unlink(tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\tfs.rename(`${ tmpFile }.tmp`, tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {\n\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\tsize,\n\t\t\t\t\t\t\t\t\tidentify\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfut.return();\n\t\t\t\t\t\t}));\n\t\t\t\t\t}));\n\t\t\t\t})).catch((err) => {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tfut.return();\n\t\t\t\t});\n\t\t}));\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\trequestCanAccessFiles({ headers = {}, query = {} }) {\n\t\tif (!RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\t\treturn true;\n\t\t}\n\n\t\tlet { rc_uid, rc_token } = query;\n\n\t\tif (!rc_uid && headers.cookie) {\n\t\t\trc_uid = cookie.get('rc_uid', headers.cookie) ;\n\t\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t\t}\n\n\t\tif (!rc_uid || !rc_token || !RocketChat.models.Users.findOneByIdAndLoginToken(rc_uid, rc_token)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t},\n\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tif (store && store.get) {\n\t\t\treturn store.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t}\n});\n\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tfileData.size = parseInt(fileData.size) || 0;\n\n\t\t// Check if the fileData matches store filter\n\t\tconst filter = this.store.getFilter();\n\t\tif (filter && filter.check) {\n\t\t\tfilter.check(fileData);\n\t\t}\n\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\n\nWebApp.connectHandlers.use('/file-upload/',\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && !FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\treturn res.end();\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n});\n","/* globals UploadFS */\n\nimport _ from 'underscore';\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tif (RocketChat.settings.get('FileUpload_S3_Proxy')) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t} else {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t\tres.end();\n\t\t}\n\t} else {\n\t\tres.end();\n\t}\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket || !AWSAccessKeyId || !AWSSecretAccessKey) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\taccessKeyId: AWSAccessKeyId,\n\t\t\tsecretAccessKey: AWSSecretAccessKey,\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport _ from 'underscore';\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tif (RocketChat.settings.get('FileUpload_GoogleStorage_Proxy')) {\n\t\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t\t} else {\n\t\t\t\tres.setHeader('Location', fileUrl);\n\t\t\t\tres.writeHead(302);\n\t\t\t\tres.end();\n\t\t\t}\n\t\t} else {\n\t\t\tres.end();\n\t\t}\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L310\nconst readFromGridFS = function(storeName, fileId, file, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\t[rs, ws].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t}));\n\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req);\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\tres.setHeader('Content-Encoding', 'gzip');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\tres.setHeader('Content-Encoding', 'deflate');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tres.removeHeader('Content-Length');\n\t\tres.removeHeader('Content-Type');\n\t\tres.removeHeader('Content-Disposition');\n\t\tres.removeHeader('Last-Modified');\n\t\tres.setHeader('Content-Range', `bytes */${ file.size }`);\n\t\tres.writeHead(416);\n\t\tres.end();\n\t} else if (range) {\n\t\tres.setHeader('Content-Range', `bytes ${ range.start }-${ range.stop }/${ file.size }`);\n\t\tres.removeHeader('Content-Length');\n\t\tres.setHeader('Content-Length', range.stop - range.start + 1);\n\t\tres.writeHead(206);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200);\n\t\tws.pipe(res);\n\t}\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads'\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars'\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\tres.setHeader('Content-Type', file.type);\n\t\tres.setHeader('Content-Length', file.size);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\nimport _ from 'underscore';\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","import _ from 'underscore';\n\nMeteor.methods({\n\tasync 'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t\tattachment.image_preview = await FileUpload.resizeImagePreview(file);\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t\tthis.add('FileUpload_S3_Proxy', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Proxy', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport _ from 'underscore';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type,\n\t\t\t\tContentDisposition: `inline; filename=\"${ encodeURI(file.name) }\"`\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n"]}