{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:migrations/migrations.js"],"names":["_","module","watch","require","default","v","moment","DefaultMigration","version","up","Migrations","_list","options","log","logger","logIfLatest","lockExpiration","retryInterval","maxAttempts","collectionName","config","opts","extend","_collection","Mongo","Collection","makeABox","message","color","isArray","split","len","reduce","memo","msg","Math","max","length","text","map","s","lrpad","join","topLine","pad","separator","bottomLine","createLogger","prefix","check","String","level","Match","OneOf","isFunction","tag","Log","forEach","partial","add","migration","Meteor","Error","Object","freeze","push","sortBy","m","migrateTo","command","isUndefined","subcommand","attempts","migrated","_migrateTo","last","parseInt","willRetry","_sleepForMs","console","yellow","control","_getControl","RocketChat","Info","commit","hash","date","branch","process","exit","getVersion","rerun","self","currentVersion","lock","info","migrate","_findIndexByVersion","unlock","startIdx","endIdx","direction","idx","maybeName","name","models","_CacheControl","withValue","e","Date","dateMinusInterval","subtract","toDate","build","update","_id","$or","locked","lockedAt","$lt","buildAt","$ne","$set","_setControl","i","findOne","Number","Boolean","upsert","_reset","remove"],"mappings":"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","file":"/packages/rocketchat_migrations.js","sourcesContent":["/* eslint-disable */\nimport _ from 'underscore';\nimport moment from 'moment';\n/*\n\tAdds migration capabilities. Migrations are defined like:\n\n\tMigrations.add({\n\t\tup: function() {}, //*required* code to run to migrate upwards\n\t\tversion: 1, //*required* number to identify migration order\n\t\tdown: function() {}, //*optional* code to run to migrate downwards\n\t\tname: 'Something' //*optional* display name for the migration\n\t});\n\n\tThe ordering of migrations is determined by the version you set.\n\n\tTo run the migrations, set the MIGRATE environment variable to either\n\t'latest' or the version number you want to migrate to. Optionally, append\n\t',exit' if you want the migrations to exit the meteor process, e.g if you're\n\tmigrating from a script (remember to pass the --once parameter).\n\n\te.g:\n\tMIGRATE=\"latest\" mrt # ensure we'll be at the latest version and run the app\n\tMIGRATE=\"latest,exit\" mrt --once # ensure we'll be at the latest version and exit\n\tMIGRATE=\"2,exit\" mrt --once # migrate to version 2 and exit\n\n\tNote: Migrations will lock ensuring only 1 app can be migrating at once. If\n\ta migration crashes, the control record in the migrations collection will\n\tremain locked and at the version it was at previously, however the db could\n\tbe in an inconsistant state.\n*/\n\n// since we'll be at version 0 by default, we should have a migration set for it.\nvar DefaultMigration = {\n\tversion: 0,\n\tup: function() {\n\t\t// @TODO: check if collection \"migrations\" exist\n\t\t// If exists, rename and rerun _migrateTo\n\t}\n};\n\nMigrations = {\n\t_list: [DefaultMigration],\n\toptions: {\n\t\t// false disables logging\n\t\tlog: true,\n\t\t// null or a function\n\t\tlogger: null,\n\t\t// enable/disable info log \"already at latest.\"\n\t\tlogIfLatest: true,\n\t\t// lock will be valid for this amount of minutes\n\t\tlockExpiration: 5,\n\t\t// retry interval in seconds\n\t\tretryInterval: 10,\n\t\t// max number of attempts to retry unlock\n\t\tmaxAttempts: 30,\n\t\t// migrations collection name\n\t\tcollectionName: \"migrations\"\n\t\t\t// collectionName: \"rocketchat_migrations\"\n\t},\n\tconfig: function(opts) {\n\t\tthis.options = _.extend({}, this.options, opts);\n\t},\n}\n\nMigrations._collection = new Mongo.Collection(Migrations.options.collectionName);\n\n/* Create a box around messages for displaying on a console.log */\nfunction makeABox(message, color = 'red') {\n\tif (!_.isArray(message)) {\n\t\tmessage = message.split(\"\\n\");\n\t}\n\tlet len = _(message).reduce(function(memo, msg) {\n\t\treturn Math.max(memo, msg.length)\n\t}, 0) + 4;\n\tlet text = message.map((msg) => {\n\t\treturn \"|\" [color] + s.lrpad(msg, len)[color] + \"|\" [color]\n\t}).join(\"\\n\");\n\tlet topLine = \"+\" [color] + s.pad('', len, '-')[color] + \"+\" [color];\n\tlet separator = \"|\" [color] + s.pad('', len, '') + \"|\" [color];\n\tlet bottomLine = \"+\" [color] + s.pad('', len, '-')[color] + \"+\" [color];\n\treturn `\\n${topLine}\\n${separator}\\n${text}\\n${separator}\\n${bottomLine}\\n`;\n}\n\n/*\n\tLogger factory function. Takes a prefix string and options object\n\tand uses an injected `logger` if provided, else falls back to\n\tMeteor's `Log` package.\n\tWill send a log object to the injected logger, on the following form:\n\t\tmessage: String\n\t\tlevel: String (info, warn, error, debug)\n\t\ttag: 'Migrations'\n*/\nfunction createLogger(prefix) {\n\tcheck(prefix, String);\n\n\t// Return noop if logging is disabled.\n\tif (Migrations.options.log === false) {\n\t\treturn function() {};\n\t}\n\n\treturn function(level, message) {\n\t\tcheck(level, Match.OneOf('info', 'error', 'warn', 'debug'));\n\t\tcheck(message, Match.OneOf(String, [String]));\n\n\t\tvar logger = Migrations.options && Migrations.options.logger;\n\n\t\tif (logger && _.isFunction(logger)) {\n\n\t\t\tlogger({\n\t\t\t\tlevel: level,\n\t\t\t\tmessage: message,\n\t\t\t\ttag: prefix\n\t\t\t});\n\n\t\t} else {\n\t\t\tLog[level]({\n\t\t\t\tmessage: prefix + ': ' + message\n\t\t\t});\n\t\t}\n\t}\n}\n\nvar log;\n\nvar options = Migrations.options;\n\n// collection holding the control record\n\nlog = createLogger('Migrations');\n\n['info', 'warn', 'error', 'debug'].forEach(function(level) {\n\tlog[level] = _.partial(log, level);\n});\n\n// if (process.env.MIGRATE)\n//   Migrations.migrateTo(process.env.MIGRATE);\n\n// Add a new migration:\n// {up: function *required\n//  version: Number *required\n//  down: function *optional\n//  name: String *optional\n// }\nMigrations.add = function(migration) {\n\tif (typeof migration.up !== 'function')\n\t\tthrow new Meteor.Error('Migration must supply an up function.');\n\n\tif (typeof migration.version !== 'number')\n\t\tthrow new Meteor.Error('Migration must supply a version number.');\n\n\tif (migration.version <= 0)\n\t\tthrow new Meteor.Error('Migration version must be greater than 0');\n\n\t// Freeze the migration object to make it hereafter immutable\n\tObject.freeze(migration);\n\n\tthis._list.push(migration);\n\tthis._list = _.sortBy(this._list, function(m) {\n\t\treturn m.version;\n\t});\n}\n\n// Attempts to run the migrations using command in the form of:\n// e.g 'latest', 'latest,exit', 2\n// use 'XX,rerun' to re-run the migration at that version\nMigrations.migrateTo = function(command) {\n\tif (_.isUndefined(command) || command === '' || this._list.length === 0)\n\t\tthrow new Error(\"Cannot migrate using invalid command: \" + command);\n\n\tif (typeof command === 'number') {\n\t\tvar version = command;\n\t} else {\n\t\tvar version = command.split(',')[0];\n\t\tvar subcommand = command.split(',')[1];\n\t}\n\n\tconst maxAttempts = Migrations.options.maxAttempts;\n\tconst retryInterval = Migrations.options.retryInterval;\n\tfor (let attempts = 1; attempts <= maxAttempts; attempts++) {\n\t\tif (version === 'latest') {\n\t\t\tmigrated = this._migrateTo(_.last(this._list).version);\n\t\t} else {\n\t\t\tmigrated = this._migrateTo(parseInt(version), (subcommand === 'rerun'));\n\t\t}\n\t\tif (migrated) {\n\t\t\tbreak;\n\t\t} else {\n\t\t\tlet willRetry;\n\t\t\tif (attempts < maxAttempts) {\n\t\t\t\twillRetry = ` Trying again in ${retryInterval} seconds.`;\n\t\t\t\tMeteor._sleepForMs(retryInterval * 1000);\n\t\t\t} else {\n\t\t\t\twillRetry = \"\";\n\t\t\t}\n\t\t\tconsole.log(`Not migrating, control is locked. Attempt ${attempts}/${maxAttempts}.${willRetry}`.yellow);\n\t\t}\n\t}\n\tif (!migrated) {\n\t\tlet control = this._getControl(); // Side effect: upserts control document.\n\t\tconsole.log(makeABox([\n\t\t\t\"ERROR! SERVER STOPPED\",\n\t\t\t\"\",\n\t\t\t\"Your database migration control is locked.\",\n\t\t\t\"Please make sure you are running the latest version and try again.\",\n\t\t\t\"If the problem persists, please contact support.\",\n\t\t\t\"\",\n\t\t\t\"This Rocket.Chat version: \" + RocketChat.Info.version,\n\t\t\t\"Database locked at version: \" + control.version,\n\t\t\t\"Database target version: \" + (version === 'latest' ? _.last(this._list).version : version),\n\t\t\t\"\",\n\t\t\t\"Commit: \" + RocketChat.Info.commit.hash,\n\t\t\t\"Date: \" + RocketChat.Info.commit.date,\n\t\t\t\"Branch: \" + RocketChat.Info.commit.branch,\n\t\t\t\"Tag: \" + RocketChat.Info.commit.tag\n\t\t]));\n\t\tprocess.exit(1);\n\t}\n\n\t// remember to run meteor with --once otherwise it will restart\n\tif (subcommand === 'exit')\n\t\tprocess.exit(0);\n}\n\n// just returns the current version\nMigrations.getVersion = function() {\n\treturn this._getControl().version;\n}\n\n// migrates to the specific version passed in\nMigrations._migrateTo = function(version, rerun) {\n\tvar self = this;\n\tvar control = this._getControl(); // Side effect: upserts control document.\n\tvar currentVersion = control.version;\n\n\tif (lock() === false) {\n\t\t// log.info('Not migrating, control is locked.');\n\t\t// Warning\n\t\treturn false;\n\t}\n\n\tif (rerun) {\n\t\tlog.info('Rerunning version ' + version);\n\t\tmigrate('up', this._findIndexByVersion(version));\n\t\tlog.info('Finished migrating.');\n\t\tunlock();\n\t\treturn true;\n\t}\n\n\tif (currentVersion === version) {\n\t\tif (this.options.logIfLatest) {\n\t\t\tlog.info('Not migrating, already at version ' + version);\n\t\t}\n\t\tunlock();\n\t\treturn true;\n\t}\n\n\tvar startIdx = this._findIndexByVersion(currentVersion);\n\tvar endIdx = this._findIndexByVersion(version);\n\n\t// log.info('startIdx:' + startIdx + ' endIdx:' + endIdx);\n\tlog.info('Migrating from version ' + this._list[startIdx].version + ' -> ' + this._list[endIdx].version);\n\n\t// run the actual migration\n\tfunction migrate(direction, idx) {\n\t\tvar migration = self._list[idx];\n\n\t\tif (typeof migration[direction] !== 'function') {\n\t\t\tunlock();\n\t\t\tthrow new Meteor.Error('Cannot migrate ' + direction + ' on version ' + migration.version);\n\t\t}\n\n\t\tfunction maybeName() {\n\t\t\treturn migration.name ? ' (' + migration.name + ')' : '';\n\t\t}\n\n\t\tlog.info('Running ' + direction + '() on version ' + migration.version + maybeName());\n\n\t\ttry {\n\t\t\tRocketChat.models._CacheControl.withValue(false, function() {\n\t\t\t\tmigration[direction](migration);\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tconsole.log(makeABox([\n\t\t\t\t\"ERROR! SERVER STOPPED\",\n\t\t\t\t\"\",\n\t\t\t\t\"Your database migration failed:\",\n\t\t\t\te.message,\n\t\t\t\t\"\",\n\t\t\t\t\"Please make sure you are running the latest version and try again.\",\n\t\t\t\t\"If the problem persists, please contact support.\",\n\t\t\t\t\"\",\n\t\t\t\t\"This Rocket.Chat version: \" + RocketChat.Info.version,\n\t\t\t\t\"Database locked at version: \" + control.version,\n\t\t\t\t\"Database target version: \" + version,\n\t\t\t\t\"\",\n\t\t\t\t\"Commit: \" + RocketChat.Info.commit.hash,\n\t\t\t\t\"Date: \" + RocketChat.Info.commit.date,\n\t\t\t\t\"Branch: \" + RocketChat.Info.commit.branch,\n\t\t\t\t\"Tag: \" + RocketChat.Info.commit.tag\n\t\t\t]));\n\t\t\tprocess.exit(1);\n\t\t}\n\t}\n\n\t// Returns true if lock was acquired.\n\tfunction lock() {\n\t\tconst date = new Date();\n\t\tconst dateMinusInterval = moment(date).subtract(self.options.lockExpiration, 'minutes').toDate();\n\t\tconst build = RocketChat.Info ? RocketChat.Info.build.date : date;\n\n\t\t// This is atomic. The selector ensures only one caller at a time will see\n\t\t// the unlocked control, and locking occurs in the same update's modifier.\n\t\t// All other simultaneous callers will get false back from the update.\n\t\treturn self._collection.update({\n\t\t\t_id: 'control',\n\t\t\t$or: [{\n\t\t\t\tlocked: false\n\t\t\t}, {\n\t\t\t\tlockedAt: {\n\t\t\t\t\t$lt: dateMinusInterval\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tbuildAt: {\n\t\t\t\t\t$ne: build\n\t\t\t\t}\n\t\t\t}]\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tlocked: true,\n\t\t\t\tlockedAt: date,\n\t\t\t\tbuildAt: build\n\t\t\t}\n\t\t}) === 1;\n\t}\n\n\n\t// Side effect: saves version.\n\tfunction unlock() {\n\t\tself._setControl({\n\t\t\tlocked: false,\n\t\t\tversion: currentVersion\n\t\t});\n\t}\n\n\tif (currentVersion < version) {\n\t\tfor (var i = startIdx; i < endIdx; i++) {\n\t\t\tmigrate('up', i + 1);\n\t\t\tcurrentVersion = self._list[i + 1].version;\n\t\t\tself._setControl({\n\t\t\t\tlocked: true,\n\t\t\t\tversion: currentVersion\n\t\t\t});\n\t\t}\n\t} else {\n\t\tfor (var i = startIdx; i > endIdx; i--) {\n\t\t\tmigrate('down', i);\n\t\t\tcurrentVersion = self._list[i - 1].version;\n\t\t\tself._setControl({\n\t\t\t\tlocked: true,\n\t\t\t\tversion: currentVersion\n\t\t\t});\n\t\t}\n\t}\n\n\tunlock();\n\tlog.info('Finished migrating.');\n}\n\n// gets the current control record, optionally creating it if non-existant\nMigrations._getControl = function() {\n\tvar control = this._collection.findOne({\n\t\t_id: 'control'\n\t});\n\n\treturn control || this._setControl({\n\t\tversion: 0,\n\t\tlocked: false\n\t});\n}\n\n// sets the control record\nMigrations._setControl = function(control) {\n\t// be quite strict\n\tcheck(control.version, Number);\n\tcheck(control.locked, Boolean);\n\n\tthis._collection.update({\n\t\t_id: 'control'\n\t}, {\n\t\t$set: {\n\t\t\tversion: control.version,\n\t\t\tlocked: control.locked\n\t\t}\n\t}, {\n\t\tupsert: true\n\t});\n\n\treturn control;\n}\n\n// returns the migration index in _list or throws if not found\nMigrations._findIndexByVersion = function(version) {\n\tfor (var i = 0; i < this._list.length; i++) {\n\t\tif (this._list[i].version === version)\n\t\t\treturn i;\n\t}\n\n\tthrow new Meteor.Error('Can\\'t find migration version ' + version);\n}\n\n//reset (mainly intended for tests)\nMigrations._reset = function() {\n\tthis._list = [{\n\t\tversion: 0,\n\t\tup: function() {}\n\t}];\n\tthis._collection.remove({});\n}\n\nRocketChat.Migrations = Migrations;\n"]}