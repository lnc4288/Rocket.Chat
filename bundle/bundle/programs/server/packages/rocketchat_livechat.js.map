{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/visitorStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/leadCapture.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getNextAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loadHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatVisitors.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","baseUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","test","html","autoupdateVersion","JSON","stringify","write","end","startup","roomTypes","setRoomFind","code","models","Rooms","findLivechatByCode","authz","addRoomAccessValidator","room","user","t","hasPermission","_id","extraData","token","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","UserPresenceEvents","on","session","status","metadata","visitor","LivechatInquiry","updateVisitorStatus","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","defer","response","HTTP","post","data","query","msg","lang","sessionId","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","LivechatVisitors","validateMessage","phoneRegexp","RegExp","msgPhones","match","emailRegexp","msgEmails","saveGuestEmailPhoneById","run","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","sendToCRM","includeMessages","messages","Messages","findVisibleByRoomId","sort","agentId","push","saveCRMDataByRoomId","open","OmniChannel","facebook","reply","page","id","text","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","findOneOpenByVisitorToken","getVisitorByToken","closeRoom","comment","findOneById","usernames","indexOf","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","fetch","check","String","servedBy","getAgentInfo","visitorToken","info","title","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","findOpenByVisitorToken","fields","cl","length","visitorEmails","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","department","Livechat_allow_switching_departments","findOnlineAgents","count","requireDeparment","getRequiredDepartment","agent","getNextAgent","limit","ls","loadMessageHistory","pageInfo","savePageHistory","registerGuest","LivechatPageVisited","keepHistoryForToken","removeAgent","customField","removeById","removeDepartment","removeManager","triggerId","validSettings","valid","every","setting","customFieldData","Match","ObjectIncluding","label","scope","visibility","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","saveRoomInfo","s","values","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","Array","actions","isString","findOneByUsername","sendMessageLivechat","guest","sendMessage","dns","header","placeholders","replace","footer","fromEmail","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","overwrite","updateLivechatDataByToken","setDepartmentForGuest","Random","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","transferData","departmentId","hasRole","transfer","postCatchError","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","log","statusCode","inquiryId","inquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","Subscriptions","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","removeByRoomId","removeUsernameById","findOne","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","update","$set","$exists","$ne","roles","findOneOnlineAgentByUsername","findAgents","findOnlineUserFromList","userList","$in","concat","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","closeOffice","self","openOffice","emails","surveyFeedback","findLivechat","filter","offset","extend","parseInt","getNextLivechatRoomCode","settingsRaw","Settings","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","closeByRoomId","closeInfo","closer","closedBy","closedAt","chatDuration","setLabelByRoomId","findOpenByAgent","newAgent","crmData","_Base","constructor","isClient","_initModel","findByRoomId","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","expireAt","findByToken","multi","removeAll","findById","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","findVisitorByToken","findOneVisitorByPhone","getNextVisitorUsername","saveGuestById","setData","unsetData","address","phoneNumber","findOneGuestByEmailAddress","emailAddress","escapeRegExp","phones","$addToSet","saveEmail","$each","savePhone","exportDefault","UAParser","historyMonitorType","logger","Logger","sections","webhook","i","queryString","getAgents","getOnlineAgents","onlineRequired","dept","onlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","alias","showConnecting","updateUser","existingUser","userData","connection","userAgent","httpHeaders","clientAddress","number","users","closeData","groupable","hideByRoomIdAndUserId","findNotHiddenPublic","setTopicAndTagsById","updateNameByRoomId","closeOpenChats","forwardOpenChats","change","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","roomCode","msgs","agentIds","setInterval","gatewayURL","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","LivechatRoomType","identifier","route","notSubscribedTpl","template","findRoom","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","getUserStatus","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","addGroup","group","public","section","i18nDescription","enableQuery","API","v1","addRoute","authRequired","unauthorized","bodyParams","failure","urlParams","put","delete","crypto","attachments","request","signature","createHmac","body","digest","mid","rooms","first_name","last_name","sucess","service","extra","fromCountry","fromState","fromCity","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tlet baseUrl;\n\tif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX && __meteor_runtime_config__.ROOT_URL_PATH_PREFIX.trim() !== '') {\n\t\tbaseUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\t} else {\n\t\tbaseUrl = '/';\n\t}\n\tif (/\\/$/.test(baseUrl) === false) {\n\t\tbaseUrl += '/';\n\t}\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"${ baseUrl }livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t<base href=\"${ baseUrl }\">\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"${ baseUrl }livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (code) => {\n\t\treturn RocketChat.models.Rooms.findLivechatByCode(code);\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && user && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user, extraData) {\n\t\treturn room.t === 'l' && extraData && extraData.token && room.v && room.v.token === extraData.token;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals UserPresenceEvents */\nMeteor.startup(() => {\n\tUserPresenceEvents.on('setStatus', (session, status, metadata) => {\n\t\tif (metadata && metadata.visitor) {\n\t\t\tRocketChat.models.LivechatInquiry.updateVisitorStatus(metadata.visitor, status);\n\t\t\tRocketChat.models.Rooms.updateVisitorStatus(metadata.visitor, status);\n\t\t}\n\t});\n});\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': `Bearer ${ apiaiKey }`\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","import LivechatVisitors from '../../server/models/LivechatVisitors';\n\nfunction validateMessage(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn false;\n\t}\n\n\t// message valid only if it is a livechat room\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn false;\n\t}\n\n\t// if the message hasn't a token, it was NOT sent from the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn false;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\tif (!validateMessage(message, room)) {\n\t\treturn message;\n\t}\n\n\tconst phoneRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_phone_regex'), 'g');\n\tconst msgPhones = message.msg.match(phoneRegexp);\n\n\tconst emailRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_email_regex'), 'gi');\n\tconst msgEmails = message.msg.match(emailRegexp);\n\n\tif (msgEmails || msgPhones) {\n\t\tLivechatVisitors.saveGuestEmailPhoneById(room.v._id, msgEmails, msgPhones);\n\n\t\tRocketChat.callbacks.run('livechat.leadCapture', room);\n\t}\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'leadCapture');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json'\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail: livechatData.visitor.email\n\t\t}\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","function sendToCRM(type, room, includeMessages = true) {\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tpostData.type = type;\n\n\tpostData.messages = [];\n\n\tif (includeMessages) {\n\t\tRocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } }).forEach((message) => {\n\t\t\tif (message.t) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst msg = {\n\t\t\t\tusername: message.u.username,\n\t\t\t\tmsg: message.msg,\n\t\t\t\tts: message.ts\n\t\t\t};\n\n\t\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\t\tmsg.agentId = message.u._id;\n\t\t\t}\n\t\t\tpostData.messages.push(msg);\n\t\t});\n\t}\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatSession', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\t// Do not send to CRM if the chat is still open\n\tif (room.open) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatEdit', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n\nRocketChat.callbacks.add('livechat.leadCapture', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_capture')) {\n\t\treturn room;\n\t}\n\treturn sendToCRM('LeadCapture', room, false);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-lead-capture');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:closeByVisitor'({ roomId, token }) {\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(token, roomId);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst language = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tvisitor,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('room-not-found', 'Room not found', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif ((!room.usernames || room.usernames.indexOf(user.username) === -1) && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment\n\t\t});\n\t}\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key')\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\t\tif (e.response.data.error.error) {\n\t\t\t\t\tthrow new Meteor.Error(e.response.data.error.error, e.response.data.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.response) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.message) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getAgentData'({ roomId, token }) {\n\t\tcheck(roomId, String);\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t}\n});\n","import _ from 'underscore';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\tvisitor: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1\n\t\t\t}\n\t\t});\n\n\t\tif (room) {\n\t\t\tinfo.visitor = visitor;\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:getNextAgent'({ token, department }) {\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(token).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!department) {\n\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\tif (requireDeparment) {\n\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t}\n\t\t}\n\n\t\tconst agent = RocketChat.Livechat.getNextAgent(department);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(agent.agentId);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loadHistory'({ token, rid, end, limit = 20, ls}) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.loadMessageHistory({ userId: visitor._id, rid, end, limit, ls });\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn {\n\t\t\t_id: user._id\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, pageInfo) {\n\t\treturn RocketChat.Livechat.savePageHistory(token, pageInfo);\n\t}\n});\n","Meteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department } = {}) {\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn {\n\t\t\tuserId\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email'\n\t\t];\n\n\t\tconst valid = settings.every((setting) => {\n\t\t\treturn validSettings.indexOf(setting._id) !== -1;\n\t\t});\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, {fields: {t: 1, servedBy: 1}});\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && room.v.token === visitor.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tsendMessageLivechat({ token, _id, rid, msg }, agent) {\n\t\tcheck(token, String);\n\t\tcheck(_id, String);\n\t\tcheck(rid, String);\n\t\tcheck(msg, String);\n\n\t\tcheck(agent, Match.Maybe({\n\t\t\tagentId: String,\n\t\t\tusername: String\n\t\t}));\n\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t\ttoken: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\treturn RocketChat.Livechat.sendMessage({\n\t\t\tguest,\n\t\t\tmessage: {\n\t\t\t\t_id,\n\t\t\t\trid,\n\t\t\t\tmsg,\n\t\t\t\ttoken\n\t\t\t},\n\t\t\tagent\n\t\t});\n\t}\n});\n","/* globals DDPRateLimiter */\nimport dns from 'dns';\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${ data.name } - ${ data.email } <${ fromEmail }>`,\n\t\t\t\treplyTo: `${ data.name } <${ data.email }>`,\n\t\t\t\tsubject: `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'livechat:setDepartmentForVisitor'({ token, department } = {}) {\n\t\tRocketChat.Livechat.setDepartmentForGuest.call(this, {\n\t\t\ttoken,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcode: 123123,\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: inquiry.code,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tconst username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(token, rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\t\tconst userLanguage = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomId(rid, { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === visitor._id) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find an online agent by his username\n * @return\n */\nRocketChat.models.Users.findOneOnlineAgentByUsername = function(username) {\n\tconst query = {\n\t\tusername,\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t'_id': userId\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tcustomFields: 1\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatByCode = function(code, fields) {\n\tcode = parseInt(code);\n\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\t// if (this.useCache) {\n\t// \treturn this.cache.findByIndex('t,code', ['l', code], options).fetch();\n\t// }\n\n\tconst query = {\n\t\tt: 'l',\n\t\tcode\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.getNextLivechatRoomCode = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorToken = function(token, roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v.token': token\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tcloser: closeInfo.closer,\n\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration,\n\t\t\t'v.status': 'offline'\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.setLabelByRoomId = function(roomId, label) {\n\treturn this.update({ _id: roomId }, { $set: { label } });\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateVisitorStatus = function(token, status) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'v.status': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ code: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'code': 1 }); // (for routing)\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark the inquiry as closed\n\t */\n\tcloseByRoomId(roomId, closeInfo) {\n\t\treturn this.update({\n\t\t\trid: roomId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'closed',\n\t\t\t\tcloser: closeInfo.closer,\n\t\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t\tchatDuration: closeInfo.chatDuration\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n\n\tupdateVisitorStatus(token, status) {\n\t\tconst query = {\n\t\t\t'v.token': token,\n\t\t\tstatus: 'open'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t'v.status': status\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass LivechatVisitors extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_visitor');\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tgetVisitorByToken(token, options) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\t/**\n\t * Find visitors by _id\n\t * @param {string} token - Visitor token\n\t */\n\tfindById(_id, options) {\n\t\tconst query = {\n\t\t\t_id\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tfindVisitorByToken(token) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.find(query);\n\t}\n\n\tupdateLivechatDataByToken(token, key, value, overwrite = true) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\tif (!overwrite) {\n\t\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t[`livechatData.${ key }`]: value\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n\n\t/**\n\t * Find a visitor by their phone number\n\t * @return {object} User from db\n\t */\n\tfindOneVisitorByPhone(phone) {\n\t\tconst query = {\n\t\t\t'phone.phoneNumber': phone\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\t/**\n\t * Get the next visitor name\n\t * @return {string} The next visitor name\n\t */\n\tgetNextVisitorUsername() {\n\t\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\t\tconst query = {\n\t\t\t_id: 'Livechat_guest_count'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tvalue: 1\n\t\t\t}\n\t\t};\n\n\t\tconst livechatCount = findAndModify(query, null, update);\n\n\t\treturn `guest-${ livechatCount.value.value + 1 }`;\n\t}\n\n\tupdateById(_id, update) {\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsaveGuestById(_id, data) {\n\t\tconst setData = {};\n\t\tconst unsetData = {};\n\n\t\tif (data.name) {\n\t\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\t\tsetData.name = s.trim(data.name);\n\t\t\t} else {\n\t\t\t\tunsetData.name = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.email) {\n\t\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\t\tsetData.visitorEmails = [\n\t\t\t\t\t{ address: s.trim(data.email) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.visitorEmails = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.phone) {\n\t\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\t\tsetData.phone = [\n\t\t\t\t\t{ phoneNumber: s.trim(data.phone) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.phone = 1;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {};\n\n\t\tif (!_.isEmpty(setData)) {\n\t\t\tupdate.$set = setData;\n\t\t}\n\n\t\tif (!_.isEmpty(unsetData)) {\n\t\t\tupdate.$unset = unsetData;\n\t\t}\n\n\t\tif (_.isEmpty(update)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tfindOneGuestByEmailAddress(emailAddress) {\n\t\tconst query = {\n\t\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i')\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tsaveGuestEmailPhoneById(_id, emails, phones) {\n\t\tconst update = {\n\t\t\t$addToSet: {}\n\t\t};\n\n\t\tconst saveEmail = [].concat(emails)\n\t\t\t.filter(email => email && email.trim())\n\t\t\t.map(email => {\n\t\t\t\treturn { address: email };\n\t\t\t});\n\n\t\tif (saveEmail.length > 0) {\n\t\t\tupdate.$addToSet.visitorEmails = { $each: saveEmail };\n\t\t}\n\n\t\tconst savePhone = [].concat(phones)\n\t\t\t.filter(phone => phone && phone.trim().replace(/[^\\d]/g, ''))\n\t\t\t.map(phone => {\n\t\t\t\treturn { phoneNumber: phone };\n\t\t\t});\n\n\t\tif (savePhone.length > 0) {\n\t\t\tupdate.$addToSet.phone = { $each: savePhone };\n\t\t}\n\n\t\tif (!update.$addToSet.visitorEmails && !update.$addToSet.phone) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n}\n\nexport default new LivechatVisitors();\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport UAParser from 'ua-parser-js';\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'External') {\n\t\t\tfor (let i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tconst queryString = department ? `?departmentId=${ department }` : '';\n\t\t\t\t\tconst result = HTTP.call('GET', `${ RocketChat.settings.get('Livechat_External_Queue_URL') }${ queryString }`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t\t\t'X-RocketChat-Secret-Token': RocketChat.settings.get('Livechat_External_Queue_Token')\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tif (result && result.data && result.data.username) {\n\t\t\t\t\t\tconst agent = RocketChat.models.Users.findOneOnlineAgentByUsername(result.data.username);\n\n\t\t\t\t\t\tif (agent) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\t\t\t\tusername: agent.username\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('Error requesting agent from external queue.', e);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t} else if (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.getNextAgent();\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRequiredDepartment(onlineRequired = true) {\n\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\n\t\treturn departments.fetch().find((dept) => {\n\t\t\tif (!dept.showOnRegistration) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (!onlineRequired) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst onlineAgents = RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(dept._id);\n\t\t\treturn onlineAgents.count() > 0;\n\t\t});\n\t},\n\tgetRoom(guest, message, roomInfo, agent) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!agent && !guest.department) {\n\t\t\t\tconst department = this.getRequiredDepartment();\n\n\t\t\t\tif (department) {\n\t\t\t\t\tguest.department = department._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo, agent);\n\n\t\t\tnewRoom = true;\n\t\t}\n\n\t\tif (!room || room.v.token !== guest.token) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo, agent }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\ttoken\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = LivechatVisitors.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t\tdepartment\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = LivechatVisitors.insert(userData);\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tupdateUser.$set.name = name;\n\t\t}\n\n\t\tLivechatVisitors.updateById(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn Meteor.users.update(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, visitor, room, comment }) {\n\t\tconst now = new Date();\n\n\t\tconst closeData = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t};\n\n\t\tif (user) {\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else if (visitor) {\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username\n\t\t\t};\n\t\t}\n\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, closeData);\n\t\tRocketChat.models.LivechatInquiry.closeByRoomId(room._id, closeData);\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tif (room.servedBy) {\n\t\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, room.servedBy._id);\n\t\t}\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, closeData.closedBy);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message'\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setLabelByRoomId(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\t\t\treturn RocketChat.models.LivechatPageVisited.saveByToken(token, pageInfo);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tconst servedBy = room.servedBy;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tcode: room.code,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = LivechatVisitors.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy && room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.label,\n\t\t\ttopic: room.topic,\n\t\t\tcode: room.code,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t}\n\t\t};\n\n\t\tif (agent) {\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\n\nRocketChat.Livechat.stream.allowRead((roomId, extraData) => {\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\tif (!room) {\n\t\tconsole.warn(`Invalid eventName: \"${ roomId }\"`);\n\t\treturn false;\n\t}\n\tif (room.t === 'l' && extraData && extraData.token && room.v.token === extraData.token) {\n\t\treturn true;\n\t}\n\treturn false;\n});\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo, agent) {\n\t\tif (!agent) {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: roomCode,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t},\n\t'External'(guest, message, roomInfo, agent) {\n\t\treturn this['Least_Amount'](guest, message, roomInfo, agent); // eslint-disable-line\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url')\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext\n\t\t\t}\n\t\t});\n\t}\n};\n","import LivechatVisitors from './models/LivechatVisitors';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = LivechatVisitors.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/*, statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email'\n\t\t\t]\n\t\t}\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date)\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (room && room.v && room.v._id) {\n\t\t// CACHE: can we stop using publications here?\n\t\treturn RocketChat.models.Rooms.findByVisitorId(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn LivechatVisitors.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v.token) {\n\t\treturn RocketChat.models.LivechatPageVisited.findByToken(room.v.token);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open'\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom, LivechatInquiry */\nimport {RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext} from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:code(\\\\d+)'\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.code);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tcode: sub.code\n\t\t};\n\t}\n}\n\nclass LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\t// icon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute()\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed'\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({code: parseInt(identifier)});\n\t}\n\n\troomName(roomData) {\n\t\tif (!roomData.name) {\n\t\t\treturn roomData.label;\n\t\t} else {\n\t\t\treturn roomData.name;\n\t\t}\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({_id: roomId}, {fields: {open: 1}});\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\t\tif (room) {\n\t\t\treturn room.v && room.v.status;\n\t\t}\n\n\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\treturn inquiry && inquiry.v && inquiry.v.status;\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomType());\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', { type: 'color', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', 'We are not online right now. Please leave us a message:', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_preregistration_form' });\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_capture', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_lead_capture'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_email_regex', '\\\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\\\.)+[A-Z]{2,4}\\\\b', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_email_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_phone_regex', '((?:\\\\([0-9]{1,3}\\\\)|[0-9]{2})[ \\\\-]*?[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$)|[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$))', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_phone_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', 'Would you like a copy of this chat emailed?', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token'\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\tvalues: [\n\t\t\t{key: 'External', i18nLabel: 'External_Service'},\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Show_queue_list_to_all_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: { $ne: 'External' } }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_URL', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'External_Queue_Service_URL',\n\t\ti18nDescription: 'For_more_details_please_check_our_docs',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Secret_token',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import crypto from 'crypto';\n\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\n\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled'\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature'\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage)\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = LivechatVisitors.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => ({ _id: user._id, username: user.username }))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n"]}